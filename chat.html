<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>QuickPucks â€” Chat Lounge</title>
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --panel:#0f1318; --text:#e8eef4; --muted:#8ea0b3; --br:#1b232d; --accent:#3c82f6 }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*::before,*::after{box-sizing:border-box}
  :focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:10px}
  /* scrollbars consistent with main app */
  *{scrollbar-width:thin;scrollbar-color:#334658 transparent}
  *::-webkit-scrollbar{height:10px;width:10px}
  *::-webkit-scrollbar-thumb{background:#334658;border-radius:999px;border:2px solid transparent;background-clip:padding-box}

  header{padding:12px 14px;background:#0f1318;border-bottom:1px solid var(--br);position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{margin:0;font-size:18px;font-weight:800}
  .pill{border:1px dashed #364353;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}

  nav.tabs{display:flex;gap:8px;padding:10px 12px;background:#0f1318;border-bottom:1px solid var(--br);position:sticky;top:52px;z-index:19;overflow-x:auto}
  nav.tabs::-webkit-scrollbar{display:none}
  .tab{padding:10px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px;flex:0 0 auto}
  .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}

  main{max-width:1160px;margin:0 auto;padding:14px 14px 64px}
  .section{display:none}
  .section.active{display:block}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:12px;margin-bottom:14px}
  .small{font-size:12px;color:var(--muted)}

  /* chat */
  .chatBlock{margin-top:10px}
  .chatTitle{display:flex;align-items:center;justify-content:space-between;margin:0 0 6px 0}
  .chatWrap{display:flex;flex-direction:column;height:48vh;min-height:320px}
  .chatList{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:#0f1318;border:1px solid #1c2430;border-radius:12px}
  .msg{background:#11171e;border:1px solid #1f2a36;border-radius:10px;padding:8px 10px}
  .msg .who{font-weight:700;font-size:13px;margin-bottom:4px;color:var(--muted)}
  .msg .text{white-space:pre-wrap;word-break:break-word}
  .msg.me{border-color:#335a7a;background:#12202d}
  .chatInput{display:flex;gap:8px;margin-top:10px}
  .chatInput input{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:10px;font-size:15px}
  .chatInput button{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Chat Lounge</h1>
  <span class="pill">QuickPucks Community</span>
  <span id="whoTag" class="pill" style="margin-left:auto">Not signed in</span>
</header>

<nav class="tabs" role="tablist" aria-label="Chat Sections">
  <button class="tab" role="tab" aria-selected="true"  aria-controls="sec-season">Season</button>
  <button class="tab" role="tab" aria-selected="false" aria-controls="sec-weekly">Weekly</button>
  <button class="tab" role="tab" aria-selected="false" aria-controls="sec-custom">Custom</button>
</nav>

<main>
  <!-- SEASON -->
  <section id="sec-season" class="section active">
    <div class="card">
      <div class="chatTitle">
        <h2 style="margin:0">Season Chat</h2>
        <span class="small">Swearing is fine. Hateful / illegal content is blocked.</span>
      </div>
      <div id="seasonMount"></div>
    </div>
  </section>

  <!-- WEEKLY -->
  <section id="sec-weekly" class="section">
    <div class="card">
      <h2 style="margin:0">Weekly Chat</h2>
      <div id="weeklyMount"><div class="small">Loadingâ€¦</div></div>
    </div>
  </section>

  <!-- CUSTOM -->
  <section id="sec-custom" class="section">
    <div class="card">
      <h2 style="margin:0">Custom Rooms</h2>
      <div id="customMount"><div class="small">Loadingâ€¦</div></div>
      <div style="margin-top:12px">
        <input id="roomName" placeholder="Room name" style="margin-bottom:6px;width:100%">
        <input id="roomPass" placeholder="Password (optional)" style="margin-bottom:6px;width:100%">
        <button id="createBtn">Create</button>
        <span id="createHint" class="small" style="margin-left:8px"></span>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* === Supabase (matches main site) === */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, {
  auth: { persistSession:true, detectSessionInUrl:true, flowType:'pkce' }
});

/* === Helpers === */
const $=id=>document.getElementById(id);
const ST={ myId:null, myEmail:null, rooms:new Map(), chans:new Map() };

function esc(txt){ return document.createTextNode(txt ?? ''); }
function chatBlock(room){
  const wrap=document.createElement('div');wrap.className='chatBlock';
  wrap.innerHTML=`
    <div class="chatWrap">
      <div class="chatList" id="list-${room.id}"><div class="small">Loadingâ€¦</div></div>
      <div class="chatInput">
        <input id="in-${room.id}" placeholder="Message ${room.name}â€¦">
        <button id="btn-${room.id}">Send</button>
      </div>
    </div>`;
  setTimeout(()=>wireRoom(room),0);
  return wrap;
}
function appendMsg(listEl, m){
  const me = ST.myId && m.user_id===ST.myId;
  const div = document.createElement('div');
  div.className = `msg ${me?'me':''}`;
  const who = document.createElement('div'); who.className='who'; who.append(esc(me?'Me':(m.user_id||'user').slice(0,6)));
  const body = document.createElement('div'); body.className='text'; body.append(esc(m.body||''));
  div.append(who,body);
  listEl.append(div);
  listEl.scrollTop = listEl.scrollHeight;
}
async function loadMsgs(roomId, listEl){
  const { data, error } = await supa
    .from('chat_messages')
    .select('id,user_id,body,created_at')
    .eq('room_id', roomId)
    .order('created_at', { ascending:true })
    .limit(120);
  if(error){ listEl.innerHTML=`<div class="small">Error: ${error.message}</div>`; return; }
  listEl.innerHTML='';
  (data||[]).forEach(m=>appendMsg(listEl,m));
}
function ensureChannel(roomId, listEl){
  if(ST.chans.has(roomId)) return;
  const ch = supa.channel(`room:${roomId}`)
    .on('postgres_changes',
      { event:'INSERT', schema:'public', table:'chat_messages', filter:`room_id=eq.${roomId}` },
      (payload)=> appendMsg(listEl, payload.new)
    )
    .subscribe();
  ST.chans.set(roomId, ch);
}
function wireRoom(room){
  const listEl = $(`list-${room.id}`);
  const inEl   = $(`in-${room.id}`);
  const btnEl  = $(`btn-${room.id}`);

  // enter to send
  inEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnEl.click(); } });

  btnEl.onclick = async ()=>{
    const msg = (inEl.value||'').trim(); if(!msg) return;
    if(!ST.myId){ alert('Sign in to send'); return; }
    const { error } = await supa.from('chat_messages').insert({ room_id: room.id, user_id: ST.myId, body: msg });
    if(error){ alert(error.message); return; }
    inEl.value='';
  };

  loadMsgs(room.id, listEl);
  ensureChannel(room.id, listEl);
}

/* === Auth banner === */
async function initAuth(){
  const { data:{ session } } = await supa.auth.getSession();
  ST.myId = session?.user?.id || null;
  ST.myEmail = session?.user?.email || null;
  $('whoTag').textContent = ST.myEmail || 'Not signed in';
  supa.auth.onAuthStateChange((_e, ses)=>{
    ST.myId = ses?.user?.id || null;
    ST.myEmail = ses?.user?.email || null;
    $('whoTag').textContent = ST.myEmail || 'Not signed in';
  });
}

/* === Week key (server handles auto-create too) === */
async function ensureCurrentWeekIfMissing(allRooms){
  const haveWeek = (allRooms||[]).some(r=>r.room_type==='week');
  if(haveWeek) return;
  // Ask server to create CURRENT week room, then reload rooms
  await supa.rpc('ensure_current_week_room').catch(()=>{});
}

/* === Renderers === */
function renderSeason(room){
  const mount=$('seasonMount'); mount.innerHTML='';
  mount.append(chatBlock(room));
}
function renderWeekly(rooms){
  const mount=$('weeklyMount'); mount.innerHTML='';
  if(!rooms.length){ mount.append(document.createElement('div')).className='small'; mount.firstChild.textContent='No weekly rooms yet.'; return; }
  // Most recent 6 by week_key
  const sorted = rooms.slice().sort((a,b)=>String(b.week_key).localeCompare(String(a.week_key))).slice(0,6);
  sorted.forEach(r=>{
    const block = document.createElement('div');
    block.className='chatBlock';
    const h = document.createElement('h3'); h.style.margin='8px 0 6px 0'; h.textContent = r.name || `Week ${r.week_key}`;
    block.append(h, chatBlock(r));
    mount.append(block);
  });
}
function renderCustom(rooms){
  const mount=$('customMount'); mount.innerHTML='';
  rooms.forEach(r=>{
    const block = document.createElement('div');
    block.className='chatBlock';
    const h = document.createElement('h3'); h.style.margin='8px 0 6px 0'; h.textContent = `${r.name}${r.has_password?' ðŸ”’':''}`;
    block.append(h, chatBlock(r));
    mount.append(block);
  });
}

/* === Create custom room === */
async function wireCreate(){
  $('createBtn').onclick = async ()=>{
    const nm = ($('roomName').value||'').trim();
    const pw = ($('roomPass').value||'').trim();
    $('createHint').textContent='';
    if(!nm){ $('createHint').textContent='Name required'; return; }
    if(!ST.myId){ $('createHint').textContent='Sign in to create rooms'; return; }
    const { data, error } = await supa.rpc('create_custom_room', {
      p_name: nm, p_description: null, p_password: pw || null
    });
    if(error){ $('createHint').textContent = error.message; return; }
    $('createHint').textContent = 'Created âœ“';
    $('roomName').value=''; $('roomPass').value='';
    await loadRooms(); // reload to show it immediately
  };
}

/* === Load rooms (and auto-create current week if none) === */
async function loadRooms(){
  const res = await supa.rpc('list_chat_rooms');
  const { data, error } = res;
  if(error){
    console.error('list_chat_rooms error', error);
    $('seasonMount').innerHTML = `<div class="small">Couldnâ€™t load rooms: ${error.message}</div>`;
    $('weeklyMount').innerHTML = '';
    $('customMount').innerHTML = '';
    return;
  }
  ST.rooms.clear(); (data||[]).forEach(r=>ST.rooms.set(r.id,r));

  // If missing any weekly room, ask server to create current one and reload once
  await ensureCurrentWeekIfMissing(data);
  if(!(data||[]).some(r=>r.room_type==='week')){
    const res2 = await supa.rpc('list_chat_rooms').catch(()=>null);
    if(res2?.data){ res2.data.forEach(r=>ST.rooms.set(r.id,r)); }
  }

  const season = [...ST.rooms.values()].find(r=>r.room_type==='season');
  const weekly = [...ST.rooms.values()].filter(r=>r.room_type==='week');
  const custom = [...ST.rooms.values()].filter(r=>r.room_type==='custom');

  if(season) renderSeason(season); else $('seasonMount').innerHTML='<div class="small">No season room yet.</div>';
  renderWeekly(weekly);
  renderCustom(custom);
}

/* === Tabs === */
document.querySelectorAll('nav.tabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('aria-controls');
    document.querySelectorAll('nav.tabs .tab').forEach(b=>b.setAttribute('aria-selected','false'));
    btn.setAttribute('aria-selected','true');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  });
});

/* === Boot === */
(async ()=>{
  await initAuth();
  await wireCreate();
  await loadRooms();
})();
</script>
</body>
</html>
