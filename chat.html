<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
<link rel="icon" type="image/png" sizes="192x192" href="logo.png">

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>QuickPucks — Chat Lounge</title>
<style>
  :root{ --bg:#0b0d10; --panel:#0f1318; --card:#12161b; --br:#1b232d; --text:#e8eef4; --muted:#8ea0b3; --accent:#3c82f6 }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*::before,*::after{box-sizing:border-box}
  :focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:10px}
  *{scrollbar-width:thin;scrollbar-color:#334658 transparent}
  *::-webkit-scrollbar{width:10px;height:10px}
  *::-webkit-scrollbar-thumb{background:#334658;border-radius:999px;border:2px solid transparent;background-clip:padding-box}

  header{padding:12px 14px;background:#0f1318;border-bottom:1px solid var(--br);display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:20}
  h1{margin:0;font-size:18px;font-weight:800}
  .pill{border:1px dashed #364353;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}
  .small{font-size:12px;color:var(--muted)}

  nav.tabs{display:flex;gap:8px;padding:10px 12px;background:#0f1318;border-bottom:1px solid var(--br);position:sticky;top:52px;z-index:19;overflow:auto}
  .tab{padding:10px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px}
  .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}

  main{max-width:1160px;margin:0 auto;padding:14px 14px 64px}
  .section{display:none}
  .section.active{display:block}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:12px;margin-bottom:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:12px;padding:10px;margin-bottom:10px}
  .sep{height:1px;background:var(--br);margin:10px 0}

  .room{border:1px solid #1c2430;background:#0f1318;border-radius:12px;padding:10px;margin:10px 0}
  .chatWrap{display:flex;flex-direction:column;height:52vh;min-height:340px}
  .chatList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:6px}
  .msg{background:#11171e;border:1px solid #1f2a36;border-radius:10px;padding:8px 10px}
  .msg.me{background:#12202d;border-color:#335a7a}
  .who{font-weight:700;font-size:12px;margin-bottom:4px}
  .text{white-space:pre-wrap;word-wrap:break-word}
  .chatInput{display:flex;gap:8px;margin-top:10px}
  .chatInput input{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:10px;font-size:15px}
  .chatInput button{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:8px;cursor:pointer}
  .chatInput button[disabled]{opacity:.6;cursor:not-allowed}

  .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .divGrid{display:grid;grid-template-columns:repeat(1,minmax(260px,1fr));gap:12px}
  @media (min-width:920px){.divGrid{grid-template-columns:repeat(2,minmax(260px,1fr))}}
  .divCard{background:#101722;border:1px solid #1c2430;border-radius:12px;padding:10px}
  .teamRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #1c2430;flex-wrap:wrap} /* <-- wrap so chat goes UNDER */
  .teamRow:last-child{border-bottom:none}

  /* NEW: team name + logo + centered chat mount */
  .teamName{display:flex;align-items:center;gap:10px}
  .teamLogo{width:26px;height:26px;object-fit:contain}
  .teamChatSpot{margin-top:8px;display:flex;justify-content:center;width:100%} /* <-- full width row below */

  /* realtime status dot */
  .rt{display:inline-flex;align-items:center;gap:6px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.ok{background:#2ad97a}.dot.wait{background:#997}.dot.err{background:#d85}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="QuickPucks Logo" style="height:40px;">
  <h1>Chat Lounge</h1>
  <span class="pill">QuickPucks Community</span>

  <!-- color picker (stores to players.chat_color) -->
  <label class="pill" style="display:inline-flex;align-items:center;gap:8px">
    My chat color
    <input id="colorPick" type="color" value="#3c82f6"
           style="width:28px;height:18px;padding:0;border:none;background:transparent;cursor:pointer">
  </label>

  <a class="btn" href="./index.html" style="margin-left:auto">← Back to App</a>
  <span class="small" style="margin-left:auto">Hateful/illegal content is blocked</span>
  <span id="whoTag" class="pill">Not signed in</span>
</header>

<nav class="tabs" role="tablist">
  <button class="tab" aria-controls="sec-season" aria-selected="true">Season</button>
  <button class="tab" aria-controls="sec-weekly" aria-selected="false">Weekly</button>
  <button class="tab" aria-controls="sec-teams"  aria-selected="false">Teams</button>
</nav>

<main>
  <!-- SEASON -->
  <section id="sec-season" class="section active">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Season Chat</h2>
        <span class="rt small"><span id="rt-season" class="dot wait"></span><span>Live</span></span>
      </div>
      <div id="seasonMount"><div class="small">Loading…</div></div>
    </div>
  </section>

  <!-- WEEKLY -->
  <section id="sec-weekly" class="section">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Week of <span id="weekRange">—</span></h2>
        <span class="rt small"><span id="rt-week" class="dot wait"></span><span>Live</span></span>
      </div>
      <div id="weeklyMount"><div class="small">Loading…</div></div>
    </div>
  </section>

  <!-- TEAMS -->
  <section id="sec-teams" class="section">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Teams</h2>
        <span class="small">Open a team to load its live chat</span>
      </div>
      <div id="teamsMount"><div class="small">Loading teams…</div></div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ====== CONFIG ====== */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, { auth:{ persistSession:true, detectSessionInUrl:true, flowType:'pkce' }});

/* ====== WEEK KEY (Mon 08:00 CT) ====== */
const TZ='America/Chicago';
function nowCT(){return new Date(new Date().toLocaleString('en-US',{timeZone:TZ}))}
function addDaysCT(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return new Date(x.toLocaleString('en-US',{timeZone:TZ}))}
function parts(d,opts){const p=new Intl.DateTimeFormat('en-US',opts).formatToParts(d);const o={};p.forEach(x=>o[x.type]=x.value);return o}
function weekKey(){
  const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addDaysCT(n,-days);
  const hour=Number(parts(n,{hour:'2-digit',hour12:false}).hour);
  const after8 = hour>=8 || days>0; const anchor = after8? mon : addDaysCT(mon,-7);
  const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'});
  return `${p.year}-${p.month}-${p.day}-Mon08CT`;
}
const CURRENT_WEEK_KEY = weekKey();

/* ====== Weekly header: "Month dd–dd" ====== */
function getWeekAnchorDate(){
  const y = Number(CURRENT_WEEK_KEY.slice(0,4));
  const m = Number(CURRENT_WEEK_KEY.slice(5,7)) - 1;
  const d = Number(CURRENT_WEEK_KEY.slice(8,10));
  return new Date(Date.UTC(y,m,d,13,0,0));
}
function weekRangeLabel(){
  const anchorUTC = getWeekAnchorDate();
  const anchor = new Date(anchorUTC.toLocaleString('en-US',{timeZone:TZ}));
  const end = addDaysCT(anchor,6);
  const fmtMonth = new Intl.DateTimeFormat('en-US',{month:'long'}).format;
  const fmtDay   = new Intl.DateTimeFormat('en-US',{day:'2-digit'}).format;
  const startMonth = fmtMonth(anchor);
  const endMonth   = fmtMonth(end);
  const startDay = fmtDay(anchor);
  const endDay   = fmtDay(end);
  return (startMonth===endMonth)
    ? `${startMonth} ${startDay}–${endDay}`
    : `${startMonth} ${startDay} – ${endMonth} ${endDay}`;
}

/* ====== NHL TEAMS ====== */
const NHL_TEAMS = [
  ['BOS','Boston Bruins','Atlantic'],['BUF','Buffalo Sabres','Atlantic'],['DET','Detroit Red Wings','Atlantic'],['FLA','Florida Panthers','Atlantic'],
  ['MTL','Montreal Canadiens','Atlantic'],['OTT','Ottawa Senators','Atlantic'],['TBL','Tampa Bay Lightning','Atlantic'],['TOR','Toronto Maple Leafs','Atlantic'],
  ['CAR','Carolina Hurricanes','Metropolitan'],['CBJ','Columbus Blue Jackets','Metropolitan'],['NJD','New Jersey Devils','Metropolitan'],['NYI','NY Islanders','Metropolitan'],
  ['NYR','NY Rangers','Metropolitan'],['PHI','Philadelphia Flyers','Metropolitan'],['PIT','Pittsburgh Penguins','Metropolitan'],['WSH','Washington Capitals','Metropolitan'],
  ['CHI','Chicago Blackhawks','Central'],['COL','Colorado Avalanche','Central'],['DAL','Dallas Stars','Central'],['MIN','Minnesota Wild','Central'],
  ['NSH','Nashville Predators','Central'],['STL','St. Louis Blues','Central'],['WPG','Winnipeg Jets','Central'],['ARI','Arizona Coyotes','Central'],
  ['ANA','Anaheim Ducks','Pacific'],['CGY','Calgary Flames','Pacific'],['EDM','Edmonton Oilers','Pacific'],['LAK','Los Angeles Kings','Pacific'],
  ['SEA','Seattle Kraken','Pacific'],['SJS','San Jose Sharks','Pacific'],['VAN','Vancouver Canucks','Pacific'],['VGK','Vegas Golden Knights','Pacific'],
];

/* ====== STATE ====== */
const ST = { me:null, chans:new Map(), lastId:new Map(), mounted:new Map() };
const $ = id => document.getElementById(id);

/* ====== display-name + color cache ====== */
const NAME_CACHE = new Map();
const COLOR_CACHE = new Map();

async function fetchDisplayNames(ids){
  const need = [...new Set(ids)].filter(id => id && (!NAME_CACHE.has(id) || !COLOR_CACHE.has(id)));
  if(!need.length) return;
  const { data, error } = await supa.from('players').select('id,display_name,chat_color').in('id', need);
  if(!error && data){
    data.forEach(r=>{
      NAME_CACHE.set(r.id, r.display_name || r.id.slice(0,6));
      COLOR_CACHE.set(r.id, r.chat_color || '#335a7a');
    });
  }
  need.forEach(id=>{
    if(!NAME_CACHE.has(id)) NAME_CACHE.set(id, id.slice(0,6));
    if(!COLOR_CACHE.has(id)) COLOR_CACHE.set(id, '#335a7a');
  });
}
function nameFor(uid, meId){ if(meId && uid===meId) return 'Me'; return NAME_CACHE.get(uid) || (uid?uid.slice(0,6):'user'); }
function hexA(hex, a=0.2){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||'#335a7a');
  const r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
  return `rgba(${r},${g},${b},${a})`;
}

/* ====== AUTH (name + color in header) ====== */
async function saveMyColor(hex){
  if(!ST.me) return;
  if(!/^#[0-9A-F]{6}$/i.test(hex)) { alert('Enter a valid hex like #FF8800'); return; }
  const { error } = await supa.from('players').update({ chat_color: hex }).eq('id', ST.me.id);
  if(error){ alert(error.message); return; }
  COLOR_CACHE.set(ST.me.id, hex);
}
async function updateWhoTag(){
  if(!ST.me){ $('whoTag').textContent = 'Not signed in'; return; }
  await fetchDisplayNames([ST.me.id]);
  $('whoTag').textContent = NAME_CACHE.get(ST.me.id) || 'Not signed in';
  const pick = $('colorPick'); if(pick) pick.value = COLOR_CACHE.get(ST.me.id) || '#3c82f6';
}
async function initAuth(){
  const { data:{session} } = await supa.auth.getSession();
  ST.me = session?.user || null;
  await updateWhoTag();
  supa.auth.onAuthStateChange((_e,s)=>{
    ST.me = s?.user || null;
    updateWhoTag();
  });
}

/* ====== FILTER ====== */
function clientFilter(txt){
  const bad=[/child\s*(porn|sex|nude|abuse)/i,/\bkill\s*(yourself|himself|herself|them)\b/i,/\brape\b/i,/\bnazi\b|\bhitler\b|\bkkk\b/i];
  return !bad.some(r=>r.test(txt||''));
}

/* ====== CHAT CORE ====== */
function chatBlock(room){
  const listId=`l-${room.id}`, inId=`i-${room.id}`, btnId=`b-${room.id}`;
  const wrap = document.createElement('div'); wrap.className='chatWrap';
  wrap.innerHTML = `
    <div id="${listId}" class="chatList"><div class="small">Loading…</div></div>
    <div class="chatInput">
      <input id="${inId}" placeholder="Message ${room.name}…">
      <button id="${btnId}">Send</button>
    </div>`;
  return {wrap,listId,inId,btnId};
}
function appendMsg(listEl, m, meId){
  const isMe = meId && m.user_id===meId;
  const div=document.createElement('div');
  div.className = 'msg'+(isMe?' me':'');
  const who = nameFor(m.user_id, meId);
  const col = COLOR_CACHE.get(m.user_id) || '#335a7a';

  div.innerHTML = `<div class="who"></div><div class="text"></div>`;
  const whoEl = div.querySelector('.who');
  whoEl.textContent = who;
  whoEl.style.color = col;
  div.style.borderColor = col;
  div.style.background = isMe ? hexA(col, .28) : hexA(col, .12);

  div.querySelector('.text').textContent = m.body || '';
  listEl.appendChild(div);
}

async function loadInitial(room_id, listEl){
  const { data, error } = await supa.from('chat_messages')
    .select('id,user_id,body,created_at')
    .eq('room_id',room_id)
    .order('created_at',{ascending:false})
    .limit(120);
  if(error){ listEl.innerHTML=`<div class="small">Error: ${error.message}</div>`; return; }
  const msgs=(data||[]).slice().reverse();
  await fetchDisplayNames(msgs.map(x=>x.user_id));
  listEl.innerHTML = msgs.length? '' : '<div class="small">Be the first to say something…</div>';
  msgs.forEach(m=>appendMsg(listEl,m,ST.me?.id));
  ST.lastId.set(room_id, msgs.length ? msgs[msgs.length-1].id : 0);
  listEl.scrollTop=listEl.scrollHeight;
}

async function pollSince(room_id, listEl){
  const since = ST.lastId.get(room_id) || 0;
  const { data, error } = await supa.from('chat_messages')
    .select('id,user_id,body,created_at')
    .eq('room_id',room_id)
    .gt('id', since)
    .order('id',{ascending:true})
    .limit(100);
  if(error || !data || !data.length) return;
  await fetchDisplayNames(data.map(x=>x.user_id));
  data.forEach(m=>appendMsg(listEl,m,ST.me?.id));
  ST.lastId.set(room_id, data[data.length-1].id);
  listEl.scrollTop=listEl.scrollHeight;
}

function ensureChannel(room_id, listEl){
  if(ST.chans.has(room_id)) return;
  const ch = supa.channel(`room:${room_id}`)
    .on('postgres_changes',
      {event:'INSERT',schema:'public',table:'chat_messages',filter:`room_id=eq.${room_id}`},
      payload => {
        fetchDisplayNames([payload.new.user_id]).then(()=>{
          appendMsg(listEl, payload.new, ST.me?.id);
          ST.lastId.set(room_id, Math.max(ST.lastId.get(room_id)||0, payload.new.id||0));
          listEl.scrollTop=listEl.scrollHeight;
        });
      }
    )
    .subscribe();
  const timer = setInterval(()=>pollSince(room_id,listEl), 5000);
  ST.chans.set(room_id,{ch,timer});
}

function disposeRoom(room_id){
  const entry = ST.chans.get(room_id);
  if(entry){
    try{ entry.ch.unsubscribe(); }catch(e){}
    if(entry.timer) clearInterval(entry.timer);
    ST.chans.delete(room_id);
  }
  ST.lastId.delete(room_id);
}

/* ====== RENDERERS ====== */
function mountRoom(container, room){
  const holder = document.createElement('div'); holder.className='room';
  holder.style.maxWidth='820px'; holder.style.width='100%';   /* keep centered nicely */
  holder.innerHTML = `<div class="row"><strong>${room.name}</strong></div>`;
  const {wrap,listId,inId,btnId}=chatBlock(room);
  holder.appendChild(wrap);
  container.appendChild(holder);

  const listEl=$(listId), inputEl=$(inId), btnEl=$(btnId);

  btnEl.onclick = async ()=>{
    const msg=(inputEl.value||'').trim(); if(!msg) return;
    if(!clientFilter(msg)){ alert('Message blocked by content rules.'); return; }
    if(!ST.me){ alert('Sign in to send messages.'); return; }
    const { error } = await supa.from('chat_messages').insert({ room_id: room.id, user_id: ST.me.id, body: msg });
    if(error){ alert(error.message); return; }
    inputEl.value='';
  };
  inputEl.addEventListener('keydown', e=>{
    if(e.key === 'Enter'){ e.preventDefault(); btnEl.click(); }
  });

  loadInitial(room.id, listEl);
  ensureChannel(room.id, listEl);
  return holder;
}

function renderSeason(all){
  const mount=$('seasonMount'); mount.innerHTML='';
  const season = all.find(r=>r.room_type==='season' && r.league==='NHL');
  if(!season){ mount.innerHTML='<div class="small">No season room yet.</div>'; return; }
  mountRoom(mount, season);
}

function renderWeekly(all){
  const mount=$('weeklyMount'); mount.innerHTML='';
  const wk = all.find(r=>r.room_type==='week' && r.week_key===CURRENT_WEEK_KEY);
  if(!wk){ mount.innerHTML=`<div class="small">No room for ${CURRENT_WEEK_KEY} yet.</div>`; return; }
  const wr = document.getElementById('weekRange');
  if(wr) wr.textContent = weekRangeLabel();
  mountRoom(mount, wk);
}

/* ====== TEAMS (logos + centered chat) ====== */
const LOGO_URL = (abbr)=>{
  const map={
    BOS:'bos', BUF:'buf', DET:'det', FLA:'fla', MTL:'mtl', OTT:'ott', TBL:'tb',  TOR:'tor',
    CAR:'car', CBJ:'cbj', NJD:'nj',  NYI:'nyi', NYR:'nyr', PHI:'phi', PIT:'pit', WSH:'wsh',
    CHI:'chi', COL:'col', DAL:'dal', MIN:'min', NSH:'nsh', STL:'stl', WPG:'wpg', ARI:'ari',
    ANA:'ana', CGY:'cgy', EDM:'edm', LAK:'la',  SEA:'sea', SJS:'sj',  VAN:'van', VGK:'vgk'
  };
  const code = map[abbr] || abbr.toLowerCase();
  return `https://a.espncdn.com/i/teamlogos/nhl/500/scoreboard/${code}.png`;
};

async function getOrCreateTeamRoom(abbr, name){
  let { data:found, error } = await supa
    .from('chat_rooms')
    .select('id,room_type,team_abbr,name,has_password')
    .eq('room_type','team').eq('league','NHL').eq('team_abbr',abbr)
    .maybeSingle();
  if(found) return found;
  if(error && error.code!=='PGRST116') throw error;
  if(!ST.me){ throw new Error('Sign in to create team rooms.'); }
  const { data, error:insErr } = await supa
    .from('chat_rooms')
    .insert({ room_type:'team', league:'NHL', team_abbr:abbr, name:`${name} Chat`, created_by: ST.me.id })
    .select('id,room_type,team_abbr,name,has_password')
    .single();
  if(insErr) throw insErr;
  return data;
}

function renderTeamsShell(){
  const mount=$('teamsMount'); mount.innerHTML='';
  const byDiv = new Map();
  NHL_TEAMS.forEach(([abbr,name,div])=>{
    if(!byDiv.has(div)) byDiv.set(div,[]);
    byDiv.get(div).push({abbr,name});
  });

  const grid=document.createElement('div'); grid.className='divGrid';

  [...byDiv.keys()].sort().forEach(div=>{
    const card=document.createElement('div'); card.className='divCard';
    card.innerHTML=`<div class="row"><strong>${div} Division</strong></div><div class="sep"></div>`;

    byDiv.get(div).forEach(t=>{
      const row=document.createElement('div'); row.className='teamRow';
      row.innerHTML = `
        <div class="teamName">
          <img class="teamLogo" src="${LOGO_URL(t.abbr)}" alt="${t.abbr} logo">
          <strong>${t.name}</strong>
        </div>
        <div>
          <button class="btn" data-state="closed">Open chat</button>
        </div>`;
      const btn=row.querySelector('button');

      const mountSpot=document.createElement('div');   /* centered mount UNDER name+logo */
      mountSpot.className='teamChatSpot';
      row.appendChild(mountSpot);

      btn.onclick = async ()=>{
        if(btn.dataset.state === 'open'){
          const rid = ST.mounted.get(t.abbr);
          if(rid){ disposeRoom(rid); }
          mountSpot.innerHTML='';
          ST.mounted.delete(t.abbr);
          btn.dataset.state='closed';
          btn.textContent='Open chat';
          return;
        }
        btn.disabled=true; btn.textContent='Opening…';
        try{
          const room = await getOrCreateTeamRoom(t.abbr, t.name);
          mountSpot.innerHTML='';
          const holder = mountRoom(mountSpot, room);
          ST.mounted.set(t.abbr, room.id);
          btn.dataset.state='open';
          btn.textContent='Close';
        }catch(e){
          alert(e.message || 'Could not open room');
          btn.dataset.state='closed';
          btn.textContent='Open chat';
        }finally{
          btn.disabled=false;
        }
      };

      card.appendChild(row);
    });

    grid.appendChild(card);
  });

  mount.appendChild(grid);
}

/* ====== LOAD ROOMS ====== */
function renderAll(all){ renderSeason(all); renderWeekly(all); renderTeamsShell(); }

async function loadRooms(){
  const { data, error } = await supa.rpc('list_chat_rooms');
  if(error){
    const msg = `Couldn’t load rooms: ${error.message}`;
    $('seasonMount').innerHTML = `<div class="small">${msg}</div>`;
    $('weeklyMount').innerHTML = '';
    $('teamsMount').innerHTML = '';
    return;
  }
  if(!data || !data.length){
    const seed = await supa.rpc('ensure_core_rooms');
    if(seed.error){
      $('seasonMount').innerHTML = `<div class="small">No rooms & couldn’t seed: ${seed.error.message}</div>`;
      return;
    }
    const again = await supa.rpc('list_chat_rooms');
    renderAll(again.data||[]);
    return;
  }
  renderAll(data);
}

/* ====== Tabs ====== */
document.querySelectorAll('nav.tabs .tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id = btn.getAttribute('aria-controls');
    document.querySelectorAll('nav.tabs .tab').forEach(b=>b.setAttribute('aria-selected','false'));
    btn.setAttribute('aria-selected','true');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  });
});

/* ====== Boot ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  const wr = document.getElementById('weekRange');
  if(wr) wr.textContent = weekRangeLabel();
  const pick = document.getElementById('colorPick');
  if(pick){ pick.addEventListener('input', e => saveMyColor(e.target.value)); }
});

(async ()=>{
  await initAuth();
  await loadRooms();
})();
</script>
</body>
</html>
