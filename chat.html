<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>QuickPucks — Chat Lounge</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#0f1318; --card:#12161b; --br:#1b232d;
    --text:#e8eef4; --muted:#8ea0b3; --accent:#3c82f6;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*::before,*::after{box-sizing:border-box}
  :focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:10px}
  header{padding:12px 14px;background:#0f1318;border-bottom:1px solid var(--br);display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:20}
  h1{margin:0;font-size:18px;font-weight:800}
  .sub{color:var(--muted);font-size:13px}
  .pill{border:1px dashed #364353;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}
  nav.tabs{display:flex;gap:8px;padding:10px 12px;background:#0f1318;border-bottom:1px solid var(--br);position:sticky;top:52px;z-index:19;overflow:auto}
  .tab{padding:10px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px}
  .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}
  main{max-width:1160px;margin:0 auto;padding:14px 14px 64px}
  .section{display:none}
  .section.active{display:block}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:12px;margin-bottom:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:12px;padding:10px;margin-bottom:10px}
  .small{font-size:12px;color:var(--muted)}
  .sep{height:1px;background:var(--br);margin:10px 0}
  .room{border:1px solid #1c2430;background:#0f1318;border-radius:12px;padding:10px;margin-bottom:10px}
  .chatWrap{display:flex;flex-direction:column;height:52vh;min-height:340px}
  .chatList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:6px}
  .msg{background:#11171e;border:1px solid #1f2a36;border-radius:10px;padding:8px 10px}
  .msg.me{background:#12202d;border-color:#335a7a}
  .who{font-weight:700;font-size:12px;color:#9db0c4;margin-bottom:4px}
  .text{white-space:pre-wrap;word-wrap:break-word}
  .chatInput{display:flex;gap:8px;margin-top:10px}
  .chatInput input{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:10px;font-size:15px}
  .chatInput button{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:8px;cursor:pointer}
  .chatInput button[disabled]{opacity:.6;cursor:not-allowed}
  .divGrid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
  @media (min-width:920px){.divGrid{grid-template-columns:repeat(4,minmax(260px,1fr))}}
  .divCard{background:#101722;border:1px solid #1c2430;border-radius:12px;padding:10px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<header>
  <h1>Chat Lounge</h1>
  <span class="pill">QuickPucks Community</span>
  <span class="small" style="margin-left:auto">Hateful/illegal content is blocked</span>
  <span id="whoTag" class="pill">Not signed in</span>
</header>

<nav class="tabs" role="tablist">
  <button class="tab" aria-controls="sec-season" aria-selected="true">Season</button>
  <button class="tab" aria-controls="sec-weekly" aria-selected="false">Weekly</button>
  <button class="tab" aria-controls="sec-teams"  aria-selected="false">Teams</button>
  <button class="tab" aria-controls="sec-custom" aria-selected="false">Custom</button>
</nav>

<main>
  <section id="sec-season" class="section active">
    <div class="card"><h2>Season Chat</h2><div id="seasonMount">Loading…</div></div>
  </section>
  <section id="sec-weekly" class="section">
    <div class="card"><h2>Weekly</h2><div id="weeklyMount">Loading…</div></div>
  </section>
  <section id="sec-teams" class="section">
    <div class="card"><h2>Teams</h2><div id="teamsMount">Loading…</div></div>
  </section>
  <section id="sec-custom" class="section">
    <div class="card"><h2>Custom Rooms</h2>
      <div class="panel row">
        <input id="roomName" placeholder="Room name" style="flex:1">
        <input id="roomPass" placeholder="Password (optional)" style="width:220px">
        <button id="createBtn" class="btn">Create</button>
      </div>
      <div id="createHint" class="small"></div>
      <div id="customMount">Loading…</div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supa = supabase.createClient("https://acmqdokxwnkkjmfgfyhh.supabase.co",
 "YOUR_ANON_KEY_HERE");

// ---------- Auth ----------
let currentUser=null;
async function initAuth(){
  const { data:{session} }=await supa.auth.getSession();
  currentUser=session?.user||null;
  document.getElementById("whoTag").textContent=currentUser?.email||"Not signed in";
  supa.auth.onAuthStateChange((_e,s)=>{currentUser=s?.user||null;document.getElementById("whoTag").textContent=currentUser?.email||"Not signed in";});
}

// ---------- Chat UI ----------
function chatBox(room){
  return `<div class="chatWrap">
    <div id="list-${room.id}" class="chatList">Loading…</div>
    <div class="chatInput">
      <input id="in-${room.id}" placeholder="Message ${room.name}…"/>
      <button id="btn-${room.id}">Send</button>
    </div></div>`;
}
function addMsg(el,m){
  const div=document.createElement("div");
  div.className="msg"+(currentUser&&m.user_id===currentUser.id?" me":"");
  div.innerHTML=`<div class="who">${m.user_id?.slice(0,6)||"anon"}</div><div class="text"></div>`;
  div.querySelector(".text").textContent=m.body;
  el.appendChild(div);
}
async function loadMsgs(room){
  const list=document.getElementById("list-"+room.id);
  const {data}=await supa.from("chat_messages").select("*").eq("room_id",room.id).order("created_at",{ascending:true});
  list.innerHTML="";
  (data||[]).forEach(m=>addMsg(list,m));
  list.scrollTop=list.scrollHeight;
  supa.channel("room:"+room.id)
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`room_id=eq.${room.id}`},
      payload=>{addMsg(list,payload.new);list.scrollTop=list.scrollHeight;})
    .subscribe();
  document.getElementById("btn-"+room.id).onclick=async()=>{
    const txt=document.getElementById("in-"+room.id).value.trim();if(!txt)return;
    await supa.from("chat_messages").insert({room_id:room.id,user_id:currentUser.id,body:txt});
    document.getElementById("in-"+room.id).value="";
  };
}

// ---------- Render ----------
function renderSection(mountId,rooms,filter){
  const mount=document.getElementById(mountId); mount.innerHTML="";
  const list=rooms.filter(filter);
  if(!list.length){ mount.textContent="No rooms yet."; return; }
  list.forEach(r=>{
    const box=document.createElement("div"); box.className="room"; box.innerHTML=`<strong>${r.name}</strong>`+chatBox(r);
    mount.appendChild(box); loadMsgs(r);
  });
}
async function loadRooms(){
  const {data}=await supa.rpc("list_chat_rooms"); if(!data)return;
  renderSection("seasonMount",data,r=>r.room_type==="season");
  renderSection("weeklyMount",data,r=>r.room_type==="week");
  renderSection("customMount",data,r=>r.room_type==="custom");
  // Teams grouped
  const teams=document.getElementById("teamsMount"); teams.innerHTML="";
  data.filter(r=>r.room_type==="team").forEach(r=>{
    const box=document.createElement("div"); box.className="room"; box.innerHTML=`<strong>${r.name}</strong>`+chatBox(r);
    teams.appendChild(box); loadMsgs(r);
  });
}

// ---------- Custom create ----------
document.getElementById("createBtn").onclick=async()=>{
  const nm=document.getElementById("roomName").value.trim();
  const pw=document.getElementById("roomPass").value.trim();
  if(!nm){document.getElementById("createHint").textContent="Name required.";return;}
  await supa.rpc("create_custom_room",{p_name:nm,p_password:pw||null});
  document.getElementById("createHint").textContent="Created ✓"; await loadRooms();
};

// ---------- Tabs ----------
document.querySelectorAll("nav.tabs .tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab").forEach(b=>b.setAttribute("aria-selected","false"));
    btn.setAttribute("aria-selected","true");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.getAttribute("aria-controls")).classList.add("active");
  };
});

// ---------- Boot ----------
(async()=>{await initAuth();await loadRooms();})();
</script>
</body>
</html>
