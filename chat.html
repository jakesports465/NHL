<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>QuickPucks — Chat Lounge</title>
<style>
  :root{ --bg:#0b0d10; --panel:#0f1318; --card:#12161b; --br:#1b232d; --text:#e8eef4; --muted:#8ea0b3; --accent:#3c82f6 }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*::before,*::after{box-sizing:border-box}
  :focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:10px}
  *{scrollbar-width:thin;scrollbar-color:#334658 transparent}
  *::-webkit-scrollbar{width:10px;height:10px}
  *::-webkit-scrollbar-thumb{background:#334658;border-radius:999px;border:2px solid transparent;background-clip:padding-box}

  header{padding:12px 14px;background:#0f1318;border-bottom:1px solid var(--br);display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:20}
  h1{margin:0;font-size:18px;font-weight:800}
  .pill{border:1px dashed #364353;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}
  .small{font-size:12px;color:var(--muted)}

  nav.tabs{display:flex;gap:8px;padding:10px 12px;background:#0f1318;border-bottom:1px solid var(--br);position:sticky;top:52px;z-index:19;overflow:auto}
  .tab{padding:10px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px}
  .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}

  main{max-width:1160px;margin:0 auto;padding:14px 14px 64px}
  .section{display:none}
  .section.active{display:block}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:12px;margin-bottom:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:12px;padding:10px;margin-bottom:10px}
  .sep{height:1px;background:var(--br);margin:10px 0}

  .room{border:1px solid #1c2430;background:#0f1318;border-radius:12px;padding:10px;margin-bottom:10px}
  .chatWrap{display:flex;flex-direction:column;height:52vh;min-height:340px}
  .chatList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:6px}
  .msg{background:#11171e;border:1px solid #1f2a36;border-radius:10px;padding:8px 10px}
  .msg.me{background:#12202d;border-color:#335a7a}
  .who{font-weight:700;font-size:12px;color:#9db0c4;margin-bottom:4px}
  .text{white-space:pre-wrap;word-wrap:break-word}
  .chatInput{display:flex;gap:8px;margin-top:10px}
  .chatInput input{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:10px;font-size:15px}
  .chatInput button{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:8px;cursor:pointer}
  .chatInput button[disabled]{opacity:.6;cursor:not-allowed}

  .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* realtime status dot */
  .rt{display:inline-flex;align-items:center;gap:6px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.ok{background:#2ad97a}.dot.wait{background:#997}.dot.err{background:#d85}
</style>
</head>
<body>
<header>
  <h1>Chat Lounge</h1>
  <span class="pill">QuickPucks Community</span>
  <a class="btn" href="./index.html" style="margin-left:auto">← Back to App</a>
  <span class="small" style="margin-left:auto">Hateful/illegal content is blocked</span>
  <span id="whoTag" class="pill">Not signed in</span>
</header>

<nav class="tabs" role="tablist">
  <button class="tab" aria-controls="sec-season" aria-selected="true">Season</button>
  <button class="tab" aria-controls="sec-weekly" aria-selected="false">Weekly</button>
</nav>

<main>
  <!-- SEASON -->
  <section id="sec-season" class="section active">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Season Chat</h2>
        <span class="rt small"><span id="rt-season" class="dot wait"></span><span>Live</span></span>
      </div>
      <div id="seasonMount"><div class="small">Loading…</div></div>
    </div>
  </section>

  <!-- WEEKLY -->
  <section id="sec-weekly" class="section">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Week of <span id="weekRange">—</span></h2>
        <span class="rt small"><span id="rt-week" class="dot wait"></span><span>Live</span></span>
      </div>
      <div id="weeklyMount"><div class="small">Loading…</div></div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ====== CONFIG ====== */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, { auth:{ persistSession:true, detectSessionInUrl:true, flowType:'pkce' }});

/* ====== WEEK KEY (Mon 08:00 CT) ====== */
const TZ='America/Chicago';
function nowCT(){return new Date(new Date().toLocaleString('en-US',{timeZone:TZ}))}
function addDaysCT(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return new Date(x.toLocaleString('en-US',{timeZone:TZ}))}
function parts(d,opts){const p=new Intl.DateTimeFormat('en-US',opts).formatToParts(d);const o={};p.forEach(x=>o[x.type]=x.value);return o}
function weekKey(){
  const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addDaysCT(n,-days);
  const hour=Number(parts(n,{hour:'2-digit',hour12:false}).hour);
  const after8 = hour>=8 || days>0; const anchor = after8? mon : addDaysCT(mon,-7);
  const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'});
  return `${p.year}-${p.month}-${p.day}-Mon08CT`;
}
const CURRENT_WEEK_KEY = weekKey();

/* ====== Weekly header: "Month dd–dd" ====== */
function getWeekAnchorDate(){
  const y = Number(CURRENT_WEEK_KEY.slice(0,4));
  const m = Number(CURRENT_WEEK_KEY.slice(5,7)) - 1;
  const d = Number(CURRENT_WEEK_KEY.slice(8,10));
  return new Date(Date.UTC(y,m,d,13,0,0));
}
function weekRangeLabel(){
  const anchorUTC = getWeekAnchorDate();
  const anchor = new Date(anchorUTC.toLocaleString('en-US',{timeZone:TZ}));
  const end = addDaysCT(anchor,6);
  const fmtMonth = new Intl.DateTimeFormat('en-US',{month:'long'}).format;
  const fmtDay   = new Intl.DateTimeFormat('en-US',{day:'2-digit'}).format;
  const startMonth = fmtMonth(anchor);
  const endMonth   = fmtMonth(end);
  const startDay = fmtDay(anchor);
  const endDay   = fmtDay(end);
  return (startMonth===endMonth)
    ? `${startMonth} ${startDay}–${endDay}`
    : `${startMonth} ${startDay} – ${endMonth} ${endDay}`;
}

/* ====== STATE ====== */
const ST = { me:null, chans:new Map(), lastId:new Map() };
const $ = id => document.getElementById(id);

/* ====== display-name cache + helpers ====== */
const NAME_CACHE = new Map();
async function fetchDisplayNames(ids){
  const need = [...new Set(ids)].filter(id => id && !NAME_CACHE.has(id));
  if(!need.length) return;
  const { data, error } = await supa.from('players').select('id,display_name').in('id', need);
  if(!error && data){ data.forEach(r=> NAME_CACHE.set(r.id, r.display_name || r.id.slice(0,6))); }
  need.forEach(id => { if(!NAME_CACHE.has(id)) NAME_CACHE.set(id, id.slice(0,6)); });
}
function nameFor(uid, meId){ if(meId && uid===meId) return 'Me'; return NAME_CACHE.get(uid) || (uid?uid.slice(0,6):'user'); }

/* ====== AUTH (display name in header) ====== */
async function updateWhoTag(){
  if(!ST.me){ $('whoTag').textContent = 'Not signed in'; return; }
  await fetchDisplayNames([ST.me.id]);
  const dn = NAME_CACHE.get(ST.me.id);
  $('whoTag').textContent = dn || 'Not signed in';
}
async function initAuth(){
  const { data:{session} } = await supa.auth.getSession();
  ST.me = session?.user || null;
  await updateWhoTag();
  supa.auth.onAuthStateChange((_e,s)=>{
    ST.me = s?.user || null;
    updateWhoTag();
  });
}

/* ====== FILTER ====== */
function clientFilter(txt){
  const bad=[/child\s*(porn|sex|nude|abuse)/i,/\bkill\s*(yourself|himself|herself|them)\b/i,/\brape\b/i,/\bnazi\b|\bhitler\b|\bkkk\b/i];
  return !bad.some(r=>r.test(txt||''));
}

/* ====== CHAT CORE ====== */
function chatBlock(room, rtDotId){
  const listId=`l-${room.id}`, inId=`i-${room.id}`, btnId=`b-${room.id}`;
  const wrap = document.createElement('div'); wrap.className='chatWrap';
  wrap.innerHTML = `
    <div id="${listId}" class="chatList"><div class="small">Loading…</div></div>
    <div class="chatInput">
      <input id="${inId}" placeholder="Message ${room.name}…">
      <button id="${btnId}">Send</button>
    </div>`;
  return {wrap,listId,inId,btnId,rtDotId};
}
function appendMsg(listEl, m, meId){
  const isMe = meId && m.user_id===meId;
  const div=document.createElement('div');
  div.className = 'msg'+(isMe?' me':'');
  const who = nameFor(m.user_id, meId);
  div.innerHTML = `<div class="who"></div><div class="text"></div>`;
  div.querySelector('.who').textContent = who;
  div.querySelector('.text').textContent = m.body || '';
  listEl.appendChild(div);
}
async function loadInitial(room_id, listEl){
  const { data, error } = await supa.from('chat_messages')
    .select('id,user_id,body,created_at')
    .eq('room_id',room_id)
    .order('created_at',{ascending:false})
    .limit(120);
  if(error){ listEl.innerHTML=`<div class="small">Error: ${error.message}</div>`; return; }
  const msgs=(data||[]).slice().reverse();
  await fetchDisplayNames(msgs.map(x=>x.user_id));
  listEl.innerHTML = msgs.length? '' : '<div class="small">Be the first to say something…</div>';
  msgs.forEach(m=>appendMsg(listEl,m,ST.me?.id));
  ST.lastId.set(room_id, msgs.length ? msgs[msgs.length-1].id : 0);
  listEl.scrollTop=listEl.scrollHeight;
}
async function pollSince(room_id, listEl){
  const since = ST.lastId.get(room_id) || 0;
  const { data, error } = await supa.from('chat_messages')
    .select('id,user_id,body,created_at')
    .eq('room_id',room_id)
    .gt('id', since)
    .order('id',{ascending:true})
    .limit(100);
  if(error || !data || !data.length) return;
  await fetchDisplayNames(data.map(x=>x.user_id));
  data.forEach(m=>appendMsg(listEl,m,ST.me?.id));
  ST.lastId.set(room_id, data[data.length-1].id);
  listEl.scrollTop=listEl.scrollHeight;
}
function setDot(id, cls){ const el=$(id); if(!el) return; el.classList.remove('ok','wait','err'); el.classList.add(cls); }

function ensureChannel(room_id, listEl, dotId){
  if(ST.chans.has(room_id)) return;

  const ch = supa.channel(`room:${room_id}`)
    .on('postgres_changes',
      {event:'INSERT',schema:'public',table:'chat_messages',filter:`room_id=eq.${room_id}`},
      payload => {
        fetchDisplayNames([payload.new.user_id]).then(()=>{
          appendMsg(listEl, payload.new, ST.me?.id);
          ST.lastId.set(room_id, Math.max(ST.lastId.get(room_id)||0, payload.new.id||0));
          listEl.scrollTop=listEl.scrollHeight;
        });
      }
    )
    .subscribe((status)=>{
      if(status==='SUBSCRIBED') setDot(dotId,'ok');
      else if(status==='TIMED_OUT' || status==='CLOSED' || status==='CHANNEL_ERROR') setDot(dotId,'err');
      else setDot(dotId,'wait');
    });

  ST.chans.set(room_id,{ch, timer:setInterval(()=>pollSince(room_id,listEl), 5000)});
}

/* ====== RENDERERS ====== */
function mountRoom(container, room, dotId){
  const shell=document.createElement('div'); shell.className='room';
  shell.innerHTML = `<div class="row"><strong>${room.name}</strong><span class="small">${room.has_password?'🔒':''}</span></div>`;
  const {wrap,listId,inId,btnId}=chatBlock(room, dotId);
  shell.appendChild(wrap);
  container.appendChild(shell);

  const listEl=$(listId), inputEl=$(inId), btnEl=$(btnId);

  btnEl.onclick = async ()=>{
    const msg=(inputEl.value||'').trim(); if(!msg) return;
    if(!clientFilter(msg)){ alert('Message blocked by content rules.'); return; }
    if(!ST.me){ alert('Sign in to send messages.'); return; }
    if(room.has_password){
      const pwd = prompt('This room is protected. Enter password to post:'); if(pwd===null) return;
      const { data, error } = await supa.rpc('join_chat_room',{ p_room_id: room.id, p_password: pwd });
      if(error || data!==true){ alert(error?error.message:'Incorrect password'); return; }
    }
    const { error } = await supa.from('chat_messages').insert({ room_id: room.id, user_id: ST.me.id, body: msg });
    if(error){ alert(error.message); return; }
    inputEl.value='';
  };

  /* ONLY ADD: Enter key submits */
  inputEl.addEventListener('keydown', e=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      btnEl.click();
    }
  });

  loadInitial(room.id, listEl);
  ensureChannel(room.id, listEl, dotId);
}

function renderSeason(all){
  const mount=$('seasonMount'); mount.innerHTML='';
  const season = all.find(r=>r.room_type==='season' && r.league==='NHL');
  if(!season){ mount.innerHTML='<div class="small">No season room yet.</div>'; return; }
  mountRoom(mount, season, 'rt-season');
}

function renderWeekly(all){
  const mount=$('weeklyMount'); mount.innerHTML='';
  const wk = all.find(r=>r.room_type==='week' && r.week_key===CURRENT_WEEK_KEY);
  if(!wk){ mount.innerHTML=`<div class="small">No room for ${CURRENT_WEEK_KEY} yet.</div>`; return; }
  const wr = document.getElementById('weekRange');
  if(wr) wr.textContent = weekRangeLabel();
  mountRoom(mount, wk, 'rt-week');
}

/* ====== LOAD ROOMS ====== */
function renderAll(all){ renderSeason(all); renderWeekly(all); }

async function loadRooms(){
  const { data, error } = await supa.rpc('list_chat_rooms');
  if(error){
    const msg = `Couldn’t load rooms: ${error.message}`;
    $('seasonMount').innerHTML = `<div class="small">${msg}</div>`;
    $('weeklyMount').innerHTML = '';
    return;
  }
  if(!data || !data.length){
    const seed = await supa.rpc('ensure_core_rooms');
    if(seed.error){
      $('seasonMount').innerHTML = `<div class="small">No rooms & couldn’t seed: ${seed.error.message}</div>`;
      return;
    }
    const again = await supa.rpc('list_chat_rooms');
    renderAll(again.data||[]);
    return;
  }
  renderAll(data);
}

/* ====== Tabs ====== */
document.querySelectorAll('nav.tabs .tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id = btn.getAttribute('aria-controls');
    document.querySelectorAll('nav.tabs .tab').forEach(b=>b.setAttribute('aria-selected','false'));
    btn.setAttribute('aria-selected','true');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  });
});

/* ====== Boot ====== */
(async ()=>{
  await initAuth();
  const wr = document.getElementById('weekRange');
  if(wr) wr.textContent = weekRangeLabel();
  await loadRooms();
})();
</script>
</body>
</html>

