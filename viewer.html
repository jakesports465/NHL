<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Puck’Em — Viewer</title>
<link rel="preconnect" href="https://site.api.espn.com">
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --panel:#0f1318; --muted:#8ea0b3; --text:#e8eef4; --br:#1b232d; --ok:#9be7b0; --okBr:#2e5e3f }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*:before,*:after{box-sizing:border-box}

  /* Subtle scrollbars */
  *{scrollbar-width:thin; scrollbar-color:#2a3646 transparent}
  *::-webkit-scrollbar{height:8px;width:8px}
  *::-webkit-scrollbar-thumb{background:#2a3646;border-radius:10px}
  *::-webkit-scrollbar-track{background:transparent}

  .wrap{max-width:1300px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:15;background:linear-gradient(180deg,#0f1318,rgba(15,19,24,0.6));border-bottom:1px solid var(--br)}
  header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .sub{color:var(--muted)}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;min-height:42px}
  .btn.secondary{background:#101722}
  .btn[aria-pressed="true"]{background:#182633;border-color:#31506a}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:14px}
  .section{padding:14px}
  h2{margin:0 0 10px 0}
  .small{font-size:13px;color:var(--muted)}
  .sep{height:1px;background:var(--br);margin:12px 0}

  /* Top strip */
  .topStrip{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(260px,1fr);gap:12px;overflow:auto;padding:12px}
  .tCard{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:10px;min-width:260px;display:grid;gap:6px;cursor:pointer}
  .teams{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .scoreTag{border:1px solid #26313c;border-radius:6px;padding:2px 6px;min-width:28px;text-align:center;font-weight:800}
  .fantPill{display:inline-flex;align-items:center;gap:8px;background:#0e1a14;border:1px solid var(--okBr);color:var(--ok);padding:6px 10px;border-radius:999px;font-weight:900}

  /* Spotlight */
  .spot{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media (max-width:1050px){ .spot{grid-template-columns:1fr} }
  .teamline{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#0f1318;border:1px solid #1c2430}
  .teamline img{width:48px;height:48px;border-radius:10px;border:1px solid #1e2732;background:#0d1218}
  .scoreBox{text-align:center;background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}
  .scoreNum{font-size:44px;font-weight:900}

  /* Rink container */
  .rinkPanel h3{margin:0 0 8px 0}
  .rinkBox{ width:75%; margin:0 auto; aspect-ratio:200/85; }
  .rinkInner{ position:relative; width:100%; height:100%; }
  .rinkInner svg{ position:absolute; inset:0; width:100%; height:100%; display:block; }
  .puck{ transition:transform .15s ease; }

  /* Latest plays */
  #spotLog{max-height:28vh;overflow:auto}
  .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#cfe2f5;background:#0e1620;border:1px solid #243241;border-radius:8px;padding:6px 8px}
</style>
</head>
<body>
<header>
  <div class="bar wrap">
    <div>
      <div style="font-size:18px;font-weight:800">NHL Puck’Em — Viewer</div>
      <div class="sub">Week: <b id="wkPretty">—</b> · <span id="lastUpd" class="small">—</span></div>
    </div>
    <div class="row">
      <a href="index.html" class="btn secondary" title="Back to main site">Home</a>
      <button id="btnPause" class="btn" aria-pressed="false">⏸️ Pause Rotate</button>
      <button id="btnFS" class="btn" title="Fullscreen">⛶ Fullscreen</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:12px">
  <!-- Top Games strip -->
  <section class="card section">
    <h2>Top Games (Fantasy)</h2>
    <div id="topStrip" class="topStrip" aria-live="polite">
      <div class="small" style="padding:8px">Loading…</div>
    </div>
  </section>

  <div class="sep"></div>

  <!-- Spotlight + Sidebar -->
  <section class="spot">
    <div class="card section" id="spotlight">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="spotTitle" style="margin:0">Game Spotlight</h2>
        <div class="small" id="spotStatus">—</div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="scoreBox" style="flex:1">
          <div class="small">Fantasy Score</div>
          <div id="spotFantasy" class="scoreNum">—</div>
          <div id="spotBonuses" class="small">—</div>
        </div>
        <div class="scoreBox" style="flex:1">
          <div class="small">Game Clock</div>
          <div class="scoreNum" id="spotClock" style="font-size:36px">—</div>
          <div class="small">P<span id="spotPer">—</span> · <span id="spotState">—</span></div>
        </div>
      </div>

      <div class="sep"></div>

      <!-- Rink -->
      <section class="panel rinkPanel" style="padding:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3>Rink (Live / Sim)</h3>
          <label class="small" style="display:flex;align-items:center;gap:8px">
            <input id="simToggle" type="checkbox"> Simulate
          </label>
        </div>
        <div class="rinkBox">
          <div class="rinkInner">
            <!-- 200 x 85 rink -->
            <svg id="rink" viewBox="0 0 200 85" aria-label="Hockey rink">
              <!-- ice + boards -->
              <rect x="2" y="2" width="196" height="81" rx="22" ry="22" fill="#eef3f8" stroke="#cfd8e3" stroke-width="4"/>

              <!-- lines -->
              <line x1="100" y1="2"  x2="100" y2="83" stroke="#d33"   stroke-width="2"/>
              <line x1="75"  y1="2"  x2="75"  y2="83" stroke="#2b7bd1" stroke-width="2"/>
              <line x1="125" y1="2"  x2="125" y2="83" stroke="#2b7bd1" stroke-width="2"/>
              <line x1="11"  y1="2"  x2="11"  y2="83" stroke="#d33"   stroke-width="2"/>
              <line x1="189" y1="2"  x2="189" y2="83" stroke="#d33"   stroke-width="2"/>

              <!-- center circle + dot -->
              <circle cx="100" cy="42.5" r="15" fill="none" stroke="#2b7bd1" stroke-width="1.6"/>
              <circle cx="100" cy="42.5" r="1.7" fill="#2b7bd1"/>

              <!-- end-zone faceoff circles -->
              <!-- Left end -->
              <circle cx="31" cy="21" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
              <circle cx="31" cy="64" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
              <circle cx="31" cy="21" r="1.6" fill="#d33"/>
              <circle cx="31" cy="64" r="1.6" fill="#d33"/>
              <!-- Right end -->
              <circle cx="169" cy="21" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
              <circle cx="169" cy="64" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
              <circle cx="169" cy="21" r="1.6" fill="#d33"/>
              <circle cx="169" cy="64" r="1.6" fill="#d33"/>

              <!-- neutral-zone dots -->
              <circle cx="86"  cy="42.5" r="1.6" fill="#d33"/>
              <circle cx="114" cy="42.5" r="1.6" fill="#d33"/>

              <!-- creases (bulge inward) -->
              <path d="M 11 30.5 A 12 12 0 0 1 11 54.5 A 12 12 0 0 1 11 30.5 Z"
                    fill="#3aa3ff" fill-opacity="0.9" stroke="#2b7bd1" stroke-width="1.2"/>
              <path d="M 189 54.5 A 12 12 0 0 1 189 30.5 A 12 12 0 0 1 189 54.5 Z"
                    fill="#3aa3ff" fill-opacity="0.9" stroke="#2b7bd1" stroke-width="1.2"/>

              <!-- posts (visual anchors on goal line) -->
              <rect x="9.2"  y="39" width="1.8" height="7" fill="#2b7bd1" rx="0.5"/>
              <rect x="189"  y="39" width="1.8" height="7" fill="#2b7bd1" rx="0.5"/>

              <!-- puck -->
              <circle id="puck" class="puck" cx="100" cy="42.5" r="2.6" fill="#111" stroke="#000" stroke-width="0.4"/>
            </svg>
          </div>
        </div>
        <div class="small" style="margin-top:8px">
          Live feed hook: <span class="kbd">window.setPuck({ x: 0–100, y: 0–100 })</span>
        </div>
      </section>

      <div class="sep"></div>

      <!-- Teams block (scores mirror DB/ESPN) -->
      <div id="spotTeams"></div>
    </div>

    <!-- Sidebar: Latest Plays -->
    <div class="card section">
      <h2>Latest Plays</h2>
      <div class="sep"></div>
      <div id="spotLog"></div>
    </div>
  </section>

  <div class="sep"></div>
  <div class="small">Tip: press <span class="kbd">F</span> for fullscreen, <span class="kbd">Space</span> to pause rotation.</div>
</main>

<!-- Supabase (read-only) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ------- Config (reuse your keys) ------- */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, { auth: { persistSession:false } });

/* ------- Week helpers ------- */
const TZ='America/Chicago';
const parts=(d,opts)=>Object.fromEntries(new Intl.DateTimeFormat('en-US',opts).formatToParts(d).map(p=>[p.type,p.value]));
const nowCT=()=>new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
const addCT=(d,days)=>new Date(new Date(d.getTime()+days*86400000).toLocaleString('en-US',{timeZone:TZ}));
function weekKey(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const hour=+parts(n,{hour:'2-digit',hour12:false}).hour; const anchor=(hour>=8||days>0)?mon:addCT(mon,-7); const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}-Mon08CT`; }
function weekDates(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const list=[...Array(7)].map((_,i)=>{const d=addCT(mon,i); const p=parts(d,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}`}); const pM=parts(mon,{month:'2-digit',day:'2-digit'}); const pS=parts(addCT(mon,6),{month:'2-digit',day:'2-digit'}); return {list,pretty:`${pM.month}/${pM.day} → ${pS.month}/${pS.day}`}; }
const WEEK_KEY=weekKey(); const WEEK=weekDates();
document.getElementById('wkPretty').textContent=WEEK.pretty;

/* ------- ESPN + DB helpers ------- */
const api={ scoreboard:(d)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard?dates=${d.replace(/-/g,'')}`, summary:(id)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${id}` };
const cdnNHL=t=>t?.logos?.[0]?.href?String(t.logos[0].href).replace(/^http:/,'https:'): (t?.abbreviation?`https://a.espncdn.com/i/teamlogos/nhl/500/${t.abbreviation}.png`:null);

async function getGameScore(gid){
  const { data } = await supa
    .from('game_scores')
    .select('total,home_pts,away_pts,close_bonus,ot_bonus,so_bonus')
    .eq('league','NHL').eq('week_key',WEEK_KEY).eq('game_id',String(gid)).maybeSingle();
  return data||null;
}

/* ------- State ------- */
const ST={ events:[], rows:[], idx:0, paused:false, spotId:null, simTimer:null };
const $=id=>document.getElementById(id);
const stamp=()=>{ $('lastUpd').textContent='Updated ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };

/* ------- Rink puck helpers ------- */
const puckEl = () => document.getElementById('puck');
function setPuckPct({x,y}){ // x,y in 0..100 (rink coords)
  const cx = 2 + (196 * (x/100));
  const cy = 2 + (81  * (y/100));
  // Use transform so stroke stays crisp as we animate
  const el = puckEl();
  if(el){ el.setAttribute('transform', `translate(${cx-100}, ${cy-42.5})`); } // relative to center (100,42.5)
}
window.setPuck = setPuckPct;

/* ------- UI builders ------- */
function renderTopStrip(){
  const strip=$('topStrip');
  const top=ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  if (!top.length) { strip.innerHTML = '<div class="small" style="padding:8px">No games yet.</div>'; return; }
  strip.innerHTML = top.map(r=>{
    const g=ST.events.find(e=>String(e.id)===String(r.id));
    if(!g) return '';
    const a=r.awayPts??0, h=r.homePts??0, f=r.score??0;
    return `
      <div class="tCard" data-gid="${r.id}">
        <div class="teams">
          <div class="name" style="display:flex;align-items:center;gap:8px;min-width:0">
            ${g.away.logo?`<img src="${g.away.logo}" style="width:18px;height:18px;border-radius:4px;border:1px solid #1e2732;background:#0f1318">`:''}
            ${g.away.name} @ ${g.home.name}
            ${g.home.logo?`<img src="${g.home.logo}" style="width:18px;height:18px;border-radius:4px;border:1px solid #1e2732;background:#0f1318">`:''}
          </div>
          <div class="scoreTag">${a}–${h}</div>
        </div>
        <div class="small">${r.status||''}</div>
        <div><span class="fantPill"><span>Fantasy</span><span>${Number(f||0).toFixed(2)}</span></span></div>
      </div>`;
  }).join('');

  strip.querySelectorAll('[data-gid]').forEach(el=>{
    el.onclick=()=>{ ST.spotId=el.getAttribute('data-gid'); ST.paused=true; setPauseBtn(); updateSpotlight(); document.getElementById('rink').scrollIntoView({behavior:'smooth',block:'center'}); };
  });
}

function setPauseBtn(){ $('btnPause').setAttribute('aria-pressed', ST.paused?'true':'false'); $('btnPause').textContent = ST.paused?'▶️ Resume Rotate':'⏸️ Pause Rotate'; }

async function updateSpotlight(){
  const id = ST.spotId || (ST.rows[0]?.id);
  if(!id) return;
  const g = ST.events.find(e=>String(e.id)===String(id));
  if(!g) return;

  $('spotTitle').textContent = `${g.away.name} @ ${g.home.name}`;

  // ESPN summary for status/log & score fallback
  const s = await fetch(api.summary(id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
  const comp=s?.header?.competitions?.[0]||{};
  let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });

  // DB totals
  const row = await getGameScore(id);

  // teams block
  $('spotTeams').innerHTML = `
    <div class="teamline" style="border-left:6px solid ${g.away.color?('#'+g.away.color):'#2a3643'}">
      <div style="display:flex;gap:10px;align-items:center">
        ${g.away.logo?`<img src="${g.away.logo}" alt="">`:''}
        <div style="font-weight:800">${g.away.name}</div>
      </div>
      <div style="font-weight:900">${row?.away_pts ?? (awayC?.score ?? 0)}</div>
    </div>
    <div class="teamline" style="border-left:6px solid ${g.home.color?('#'+g.home.color):'#2a3643'}">
      <div style="display:flex;gap:10px;align-items:center">
        ${g.home.logo?`<img src="${g.home.logo}" alt="">`:''}
        <div style="font-weight:800">${g.home.name}</div>
      </div>
      <div style="font-weight:900">${row?.home_pts ?? (homeC?.score ?? 0)}</div>
    </div>`;

  $('spotFantasy').textContent = (row?.total!=null?Number(row.total).toFixed(2):'—');
  const cb=Number(row?.close_bonus||0), ob=Number(row?.ot_bonus||0), sb=Number(row?.so_bonus||0);
  $('spotBonuses').textContent = `Bonuses: ${cb?`Close +${cb}`:'—'} · ${ob?`OT +${ob}`:'—'} · ${sb?`SO +${sb}`:'—'}`;
  $('spotClock').textContent = comp?.status?.displayClock || '—';
  $('spotPer').textContent   = comp?.status?.period ?? '—';
  $('spotState').textContent = comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—';
  $('spotStatus').textContent = $('spotState').textContent;

  // latest plays list
  const log=$('spotLog'); log.innerHTML='';
  (s?.scoringPlays||[]).slice(-14).reverse().forEach(sp=>{
    const t=(sp.clock?.displayValue||''), q=(sp.period?.number?'P'+sp.period.number:''), d=(sp.text||sp.description||'');
    const div=document.createElement('div'); div.textContent=`[${q} ${t}] ${d}`; log.appendChild(div);
  });
}

/* ------- Data load ------- */
async function loadWeek(){
  const all=[];
  for(const d of WEEK.list){
    const sb = await fetch(api.scoreboard(d),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const evs=sb?.events||[];
    for(const ev of evs){
      const c=ev.competitions?.[0]||{};
      let home=null,away=null; (c.competitors||[]).forEach(x=>{ if(x.homeAway==='home') home=x; if(x.homeAway==='away') away=x; });
      all.push({
        id:ev.id,
        start:ev.date,
        home:{ name:home?.team?(home.team.shortDisplayName||home.team.displayName):'Home', color:home?.team?.color||null, logo:cdnNHL(home?.team||null) },
        away:{ name:away?.team?(away.team.shortDisplayName||away.team.displayName):'Away', color:away?.team?.color||null, logo:cdnNHL(away?.team||null) }
      });
    }
  }
  all.sort((a,b)=>new Date(a.start)-new Date(b.start));
  ST.events=all;
}

async function refreshRows(){
  if(!ST.events.length) return;
  const batch = await Promise.all(ST.events.map(async g=>{
    const s = await fetch(api.summary(g.id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const row = await getGameScore(g.id);
    const comp=s?.header?.competitions?.[0]||{};
    return {
      id:g.id,
      awayPts: row?.away_pts ?? Number(comp?.competitors?.find(c=>c.homeAway==='away')?.score || 0),
      homePts: row?.home_pts ?? Number(comp?.competitors?.find(c=>c.homeAway==='home')?.score || 0),
      score: row?.total ?? 0,
      status: (comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—')
    };
  }));
  ST.rows = batch.filter(Boolean);
  stamp();
}

/* ------- Rotation & controls ------- */
function tickRotate(){
  if(ST.paused || ST.rows.length===0) return;
  const top = ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  ST.idx = (ST.idx+1) % top.length;
  ST.spotId = top[ST.idx].id;
  updateSpotlight();
}
$('btnPause').onclick=()=>{ ST.paused=!ST.paused; setPauseBtn(); };
$('btnFS').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
document.addEventListener('keydown',e=>{
  if(e.key===' '){ e.preventDefault(); ST.paused=!ST.paused; setPauseBtn(); }
  if(e.key.toLowerCase()==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
});

/* ------- Simulate puck (or feed via window.setPuck) ------- */
const simToggle = $('simToggle');
simToggle.addEventListener('change',()=>{
  clearInterval(ST.simTimer);
  if(simToggle.checked){
    ST.simTimer = setInterval(()=>{
      // light random skate with bias toward attacking zones
      const x = 10 + Math.random()*80;  // avoid boards
      const y = 8  + Math.random()*69;
      setPuckPct({x,y});
    }, 700);
  }else{
    clearInterval(ST.simTimer);
  }
});

/* ------- Boot ------- */
(async ()=>{
  await loadWeek();
  await refreshRows();
  renderTopStrip();
  setPauseBtn();
  ST.spotId = ST.rows[0]?.id || null;
  await updateSpotlight();

  // periodic updates
  setInterval(async()=>{ await refreshRows(); renderTopStrip(); if(!ST.paused) await updateSpotlight(); }, 30000);
  setInterval(tickRotate, 8000);

  // ensure rink is visible on first load
  document.getElementById('rink').scrollIntoView({block:'center'});
})();
</script>
</body>
</html>
