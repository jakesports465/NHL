<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NHL Puck’Em — Live Viewer</title>
<link rel="preconnect" href="https://site.api.espn.com">
<style>
  /* ===== Theme ===== */
  :root{
    --bg:#0b0d10; --card:#12161b; --panel:#0f1318;
    --text:#e8eef4; --muted:#95a7bb; --br:#1b232d;
    --ok:#9be7b0; --ok-br:#2e5e3f; --chip:#243241;
    --accent:#2b4d6a;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*:before,*:after{box-sizing:border-box}
  :focus-visible{outline:2px solid #3c82f6; outline-offset:2px; border-radius:10px}

  /* Scrollbar (desktop) */
  *{scrollbar-width:thin; scrollbar-color:#334658 transparent}
  *::-webkit-scrollbar{height:10px;width:10px}
  *::-webkit-scrollbar-track{background:transparent}
  *::-webkit-scrollbar-thumb{background:#334658;border-radius:999px;border:2px solid transparent;background-clip:padding-box}

  .wrap{max-width:1160px;margin:0 auto;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .sp{flex:1}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:14px}
  .section{padding:14px}
  .small{font-size:12.5px;color:var(--muted)}
  .sep{height:1px;background:var(--br);margin:12px 0}

  /* Header */
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f1318 75%,transparent);border-bottom:1px solid var(--br)}
  .title{font-size:clamp(16px,2vw,20px);font-weight:800;margin:0}
  .btn{
    background:#14202b;border:1px solid #243241;color:var(--text);
    padding:10px 12px;border-radius:10px;cursor:pointer;min-height:40px
  }
  .btn.toggle[aria-pressed="true"]{background:#182633;border-color:#31506a}
  .chip{border:1px dashed #364353;border-radius:999px;padding:6px 10px;font-size:12px}

  /* Top strip */
  .stripWrap{padding:10px}
  .topStrip{
    display:flex; gap:10px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:8px
  }
  .topCard{
    flex:0 0 260px; scroll-snap-align:start; background:#0f1318; border:1px solid #1c2430;
    border-radius:12px; padding:10px; display:grid; gap:6px; cursor:pointer
  }
  .teamsRow{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .name{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .scoreChip{border:1px solid #25313d; border-radius:8px; padding:2px 8px; font-weight:800; min-width:28px; text-align:center}
  .fantPill{display:inline-flex; align-items:center; gap:8px; background:#0e1a14; color:var(--ok);
    border:1px solid var(--ok-br); border-radius:999px; padding:6px 10px; font-weight:900}

  /* Spotlight */
  .spot{display:grid; grid-template-columns:1fr 380px; gap:14px}
  @media (max-width:1000px){ .spot{grid-template-columns:1fr} }
  .board{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  @media (max-width:640px){ .board{grid-template-columns:1fr 1fr} }
  .side{display:flex; gap:10px; align-items:center; background:#0f1318;border:1px solid #1c2430;border-radius:12px; padding:10px}
  .logo{width:42px;height:42px;border-radius:10px;border:1px solid #1e2732;background:#0d1218; flex:0 0 auto}
  .teamName{font-weight:800}
  .scoreRow{display:flex; align-items:center; justify-content:center; gap:12px; grid-column:2}
  .scoreBig{font-size:40px; font-weight:900; min-width:52px; text-align:center; border:1px solid #26313c; border-radius:10px; padding:6px 10px}
  .centerCell{display:grid; gap:8px; align-content:start}
  .badge{border:1px solid var(--chip); background:#0e1620; border-radius:999px; padding:6px 8px}

  /* Plays (accordion) */
  .acc .head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer}
  .acc .body{max-height:0; overflow:hidden; transition:max-height .25s ease}
  .acc[aria-expanded="true"] .body{max-height:60vh}
  .list{max-height:60vh; overflow:auto; padding:10px 12px}
  .play{display:grid; grid-template-columns:auto 1fr; gap:10px; padding:10px; border:1px solid #1c2430; border-radius:10px; background:#0f1318; margin-bottom:10px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.goal{background:#20d07a}
  .dot.other{background:#6aa0ff}
  .when{color:var(--muted); font-size:12px}

  /* Game grid (optional mini list when wide) */
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px}
  .gCard{background:#11171e;border:1px solid #1f2a36;border-radius:12px;padding:10px}
  .band{height:6px;border-radius:6px;margin:-10px -10px 8px}

  /* Phone polish */
  @media (max-width:420px){
    .wrap{padding:12px}
    .section{padding:12px}
    .topCard{flex:0 0 220px; height:90px}
    .logo{width:34px;height:34px}
    .teamName{font-size:14px}
    .scoreBig{font-size:32px;min-width:46px}
    .fantPill{padding:5px 9px;font-size:12.5px}
    .acc .body{max-height:52vh}
    .list{max-height:52vh}
  }
</style>
</head>
<body>
<header>
  <div class="wrap section" style="padding-block:10px">
    <div class="row">
      <h1 class="title sp">NHL Puck’Em — Live Viewer</h1>
      <a href="/" class="btn" aria-label="Home">Home</a>
      <button id="btnPause" class="btn toggle" aria-pressed="false">Pause</button>
      <button id="btnFS" class="btn" title="Fullscreen">⛶</button>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="chip">Week: <b id="wkPretty">—</b></div>
      <div class="chip">Updated <span id="lastUpd">—</span></div>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:10px">
  <!-- Top Games -->
  <section class="card section stripWrap">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h2 style="margin:0;font-size:16px">Games</h2>
      <span class="small">Click a card to spotlight</span>
    </div>
    <div id="topStrip" class="topStrip" aria-live="polite"></div>
  </section>

  <!-- Spotlight + Plays -->
  <section class="spot">
    <!-- Spotlight -->
    <section class="card section">
      <h2 id="spotTitle" style="margin:0 0 6px 0;font-size:18px">Game Spotlight</h2>
      <div class="board">
        <div class="side" id="awaySide">
          <img class="logo" id="awayLogo" alt="">
          <div>
            <div class="teamName" id="awayName">Away</div>
            <div class="small">Score <b id="awayPts">0</b></div>
          </div>
        </div>

        <div class="centerCell">
          <div class="row" style="justify-content:center;align-items:center">
            <div class="scoreBig" id="aScore">0</div>
            <div class="small" style="opacity:.8">—</div>
            <div class="scoreBig" id="hScore">0</div>
          </div>
          <div class="row" style="justify-content:center;gap:8px">
            <span class="badge small" id="clockBox">Clock —</span>
            <span class="badge small" id="stateBox">State —</span>
            <span class="fantPill" id="fantBadge">Fantasy <b id="fantVal" style="margin-left:6px">0.00</b></span>
          </div>
        </div>

        <div class="side" id="homeSide" style="justify-content:end">
          <div style="text-align:right;margin-right:6px">
            <div class="teamName" id="homeName">Home</div>
            <div class="small">Score <b id="homePts">0</b></div>
          </div>
          <img class="logo" id="homeLogo" alt="">
        </div>
      </div>
      <div class="sep"></div>

      <!-- Accordions -->
      <div class="panel acc" id="accScoring" aria-expanded="true" style="margin-bottom:10px">
        <div class="head">
          <h3 style="margin:0;font-size:15px">Scoring Plays</h3>
          <button class="btn" data-toggle="#accScoring">Toggle</button>
        </div>
        <div class="body">
          <div id="scoreList" class="list"><div class="small">No data yet.</div></div>
        </div>
      </div>

      <div class="panel acc" id="accRecent" aria-expanded="false">
        <div class="head">
          <h3 style="margin:0;font-size:15px">Recent Plays</h3>
          <button class="btn" data-toggle="#accRecent">Toggle</button>
        </div>
        <div class="body">
          <div id="recentList" class="list"><div class="small">No data yet.</div></div>
        </div>
      </div>
    </section>

    <!-- Optional mini grid (only shows on wide screens for context) -->
    <section class="card section" id="miniGridWrap">
      <h3 style="margin:0 0 6px 0">All Games</h3>
      <div class="grid" id="miniGrid"></div>
    </section>
  </section>

</main>

<!-- Supabase (read-only) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Config ===== */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, { auth:{ persistSession:false } });

/* ===== Week helpers ===== */
const TZ='America/Chicago';
const parts=(d,opts)=>Object.fromEntries(new Intl.DateTimeFormat('en-US',opts).formatToParts(d).map(p=>[p.type,p.value]));
const nowCT=()=>new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
const addCT=(d,days)=>new Date(new Date(d.getTime()+days*86400000).toLocaleString('en-US',{timeZone:TZ}));
function weekKey(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const hr=+parts(n,{hour:'2-digit',hour12:false}).hour; const anchor=(hr>=8||days>0)?mon:addCT(mon,-7); const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}-Mon08CT`; }
function weekDates(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const list=[...Array(7)].map((_,i)=>{const d=addCT(mon,i); const p=parts(d,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}`}); const pM=parts(mon,{month:'2-digit',day:'2-digit'}); const pS=parts(addCT(mon,6),{month:'2-digit',day:'2-digit'}); return {list,pretty:`${pM.month}/${pM.day} → ${pS.month}/${pS.day}`}; }
const WEEK_KEY=weekKey(); const WEEK=weekDates();
document.getElementById('wkPretty').textContent=WEEK.pretty;

/* ===== APIs ===== */
const api={ scoreboard:d=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard?dates=${d.replace(/-/g,'')}`, summary:id=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${id}` };
const cdn=t=>t?.logos?.[0]?.href?String(t.logos[0].href).replace(/^http:/,'https:'): (t?.abbreviation?`https://a.espncdn.com/i/teamlogos/nhl/500/${t.abbreviation}.png`:'');

/* ===== State ===== */
const ST={ events:[], rows:[], spotId:null, paused:false, idx:0 };
const $=id=>document.getElementById(id);
const stamp=()=>{ $('lastUpd').textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };

/* ===== DB helpers (fantasy row) ===== */
async function getGameScore(gid){
  const { data } = await supa
    .from('game_scores')
    .select('total,home_pts,away_pts,close_bonus,ot_bonus,so_bonus')
    .eq('league','NHL').eq('week_key',WEEK_KEY).eq('game_id',String(gid)).maybeSingle();
  return data||null;
}

/* ===== Render helpers ===== */
function miniCard(g, row){
  const a=row?.away_pts ?? 0, h=row?.home_pts ?? 0, f=row?.total ?? 0;
  const s = `<div class="gCard" data-gid="${g.id}">
    <div class="band" style="background:linear-gradient(90deg, ${g.away.color?('#'+g.away.color):'#203040'} 0%, ${g.home.color?('#'+g.home.color):'#2d3a49'} 100%)"></div>
    <div class="row" style="justify-content:space-between">
      <div class="name" style="max-width:72%">${g.away.name} @ ${g.home.name}</div>
      <div class="scoreChip">${Number(f).toFixed(2)}</div>
    </div>
    <div class="small" style="margin-top:6px">${new Date(g.start).toLocaleString([], {weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</div>
    <div class="row" style="margin-top:6px;justify-content:space-between">
      <span class="badge">A ${a}</span><span class="badge">H ${h}</span>
    </div>
  </div>`;
  return s;
}

function renderTopStrip(){
  const strip=$('topStrip');
  const top=ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  strip.innerHTML = top.map(r=>{
    const g=ST.events.find(e=>String(e.id)===String(r.id));
    return `<div class="topCard" data-gid="${r.id}">
      <div class="teamsRow">
        <div class="name">${g.away.name} @ ${g.home.name}</div>
        <div class="scoreChip">${Number(r.score||0).toFixed(2)}</div>
      </div>
      <div class="small">${r.status||''}</div>
      <div><span class="fantPill">Fantasy <b>${Number(r.score||0).toFixed(2)}</b></span></div>
    </div>`;
  }).join('');
  strip.querySelectorAll('[data-gid]').forEach(el=>{
    el.onclick=()=>{ ST.spotId=el.getAttribute('data-gid'); ST.paused=true; setPauseBtn(); updateSpotlight(); window.scrollTo({top:document.querySelector('.spot').offsetTop-8,behavior:'smooth'}); };
  });
}

function setPauseBtn(){ $('btnPause').setAttribute('aria-pressed', ST.paused?'true':'false'); $('btnPause').textContent = ST.paused?'Resume':'Pause'; }

async function updateSpotlight(){
  const id = ST.spotId || (ST.rows[0]?.id);
  if(!id) return;
  const g = ST.events.find(e=>String(e.id)===String(id));
  if(!g) return;

  $('spotTitle').textContent = `${g.away.name} @ ${g.home.name}`;
  $('awayName').textContent  = g.away.name;
  $('homeName').textContent  = g.home.name;
  $('awayLogo').src = g.away.logo;  $('awayLogo').width=42; $('awayLogo').height=42;
  $('homeLogo').src = g.home.logo;  $('homeLogo').width=42; $('homeLogo').height=42;

  // ESPN summary (for status & plays)
  const s = await fetch(api.summary(id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
  const comp=s?.header?.competitions?.[0]||{};
  let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });

  // DB fantasy row
  const row = await getGameScore(id);

  const a = row?.away_pts ?? Number(awayC?.score||0);
  const h = row?.home_pts ?? Number(homeC?.score||0);
  $('aScore').textContent = a; $('hScore').textContent = h;
  $('awayPts').textContent = a; $('homePts').textContent = h;
  $('fantVal').textContent  = (row?.total!=null?Number(row.total).toFixed(2):'0.00');

  const status = (comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—');
  $('clockBox').textContent = 'Clock ' + (comp?.status?.displayClock || '—');
  $('stateBox').textContent = status;

  // Plays — Scoring
  const scoring = (s?.scoringPlays||[]).slice(-20).reverse();
  const scoreList = $('scoreList');
  scoreList.innerHTML = scoring.length? scoring.map(sp=>{
    const t = `[P${sp.period?.number||'?'} ${sp.clock?.displayValue||''}]`;
    const d = (sp.text || sp.description || '').replace(/\s+/g,' ');
    return `<div class="play"><span class="dot goal"></span><div><div>${d}</div><div class="when">${t}</div></div></div>`;
  }).join('') : '<div class="small">No data yet.</div>';

  // Plays — Recent (all) from pbp if present
  const drives = (s?.plays || s?.drives || []); // ESPN varies; fallback to scoring only
  const recent = (s?.allPlays || s?.plays || []).slice(-30).reverse();
  const recentList = $('recentList');
  if(recent.length){
    recentList.innerHTML = recent.map(p=>{
      const t = `[P${p.period?.number||'?'} ${p.clock?.displayValue||''}]`;
      const text = (p.text || p.description || p.shortText || '').replace(/\s+/g,' ');
      return `<div class="play"><span class="dot other"></span><div><div>${text}</div><div class="when">${t}</div></div></div>`;
    }).join('');
  }else{
    recentList.innerHTML = '<div class="small">No data yet.</div>';
  }
}

/* ===== Data load ===== */
async function loadWeek(){
  const all=[];
  for(const d of WEEK.list){
    const sb = await fetch(api.scoreboard(d),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    for(const ev of (sb?.events||[])){
      const c=ev.competitions?.[0]||{};
      let home=null,away=null; (c.competitors||[]).forEach(x=>{ if(x.homeAway==='home') home=x; if(x.homeAway==='away') away=x; });
      all.push({
        id:ev.id,
        start:ev.date,
        home:{ name:home?.team?(home.team.shortDisplayName||home.team.displayName):'Home', color:home?.team?.color||null, logo:cdn(home?.team||null) },
        away:{ name:away?.team?(away.team.shortDisplayName||away.team.displayName):'Away', color:away?.team?.color||null, logo:cdn(away?.team||null) }
      });
    }
  }
  all.sort((a,b)=>new Date(a.start)-new Date(b.start));
  ST.events=all;
}

/* ===== Refresh fantasy/score rows ===== */
async function refreshRows(){
  if(!ST.events.length) return;
  const batch = await Promise.all(ST.events.map(async g=>{
    const s = await fetch(api.summary(g.id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const row = await getGameScore(g.id);
    const comp=s?.header?.competitions?.[0]||{};
    return {
      id:g.id,
      awayPts: row?.away_pts ?? Number(comp?.competitors?.find(c=>c.homeAway==='away')?.score || 0),
      homePts: row?.home_pts ?? Number(comp?.competitors?.find(c=>c.homeAway==='home')?.score || 0),
      score: row?.total ?? 0,
      status: (comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—')
    };
  }));
  ST.rows = batch.filter(Boolean);
  stamp();
}

/* ===== Mini grid render ===== */
function renderMini(){
  const grid=$('miniGrid'); if(!grid) return;
  grid.innerHTML = ST.events.map(g=>{
    const r=ST.rows.find(x=>String(x.id)===String(g.id));
    return miniCard(g,{away_pts:r?.awayPts,home_pts:r?.homePts,total:r?.score});
  }).join('');
  grid.querySelectorAll('[data-gid]').forEach(el=>{
    el.onclick=()=>{ ST.spotId=el.getAttribute('data-gid'); ST.paused=true; setPauseBtn(); updateSpotlight(); window.scrollTo({top:document.querySelector('.spot').offsetTop-8,behavior:'smooth'}); };
  });
}

/* ===== Rotation ===== */
function tickRotate(){
  if(ST.paused || ST.rows.length===0) return;
  const top = ST.rows.slice().sort((a,b)=>b.score-a.score);
  ST.idx = (ST.idx+1) % Math.min(top.length, 10);
  ST.spotId = top[ST.idx].id;
  updateSpotlight();
}

/* ===== Controls ===== */
$('btnPause').onclick=()=>{ ST.paused=!ST.paused; setPauseBtn(); };
$('btnFS').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
document.addEventListener('keydown',e=>{
  if(e.key===' '){ e.preventDefault(); ST.paused=!ST.paused; setPauseBtn(); }
  if(e.key.toLowerCase()==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
});

/* ===== Accordions ===== */
document.addEventListener('click',e=>{
  const t=e.target.closest('[data-toggle]'); if(!t) return;
  const sel=t.getAttribute('data-toggle'); const acc=document.querySelector(sel);
  const on = acc.getAttribute('aria-expanded')==='true';
  acc.setAttribute('aria-expanded', on?'false':'true');
});

/* ===== Boot ===== */
(async ()=>{
  // Prevent CLS by fixing logo size right away
  document.querySelectorAll('img.logo').forEach(img=>{ img.width=42; img.height=42; });

  await loadWeek();
  await refreshRows();
  renderTopStrip();
  renderMini();
  await updateSpotlight();
  setPauseBtn();

  // periodic updates
  setInterval(async()=>{ await refreshRows(); renderTopStrip(); renderMini(); if(!ST.paused) await updateSpotlight(); }, 30000);
  setInterval(tickRotate, 8000);
})();
</script>
</body>
</html>
