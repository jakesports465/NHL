<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Puck’Em — Viewer</title>
<link rel="preconnect" href="https://site.api.espn.com">
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --panel:#0f1318; --muted:#8ea0b3; --text:#e8eef4; --br:#1b232d; --ok:#9be7b0; --okBr:#2e5e3f }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*::before,*::after{box-sizing:border-box}
  :focus-visible{outline:2px solid #3c82f6; outline-offset:2px; border-radius:8px}

  /* Themed scrollbars */
  *{ scrollbar-width:thin; scrollbar-color:#334152 #0f1318 }
  *::-webkit-scrollbar{ width:10px; height:10px }
  *::-webkit-scrollbar-track{ background:#0f1318; border-left:1px solid #17202a }
  *::-webkit-scrollbar-thumb{ background:#334152; border:2px solid #0f1318; border-radius:12px }
  *::-webkit-scrollbar-thumb:hover{ background:#3f536b }

  .wrap{max-width:1300px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f1318,transparent);border-bottom:1px solid var(--br)}
  header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;min-height:42px}
  .btn[aria-pressed="true"]{background:#182633;border-color:#31506a}
  .sub{color:var(--muted)}
  .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#cfe2f5;background:#0e1620;border:1px solid #243241;border-radius:8px;padding:6px 8px}

  .card{background:var(--card);border:1px solid var(--br);border-radius:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:14px}
  .section{padding:14px}
  h2{margin:0 0 10px 0}
  .small{font-size:13px;color:var(--muted)}
  .sep{height:1px;background:var(--br);margin:12px 0}

  /* Top strip */
  .topStrip{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(280px,1fr);gap:12px;overflow:auto;padding:12px}
  .tCard{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:10px;min-width:280px;display:grid;gap:6px;cursor:pointer}
  .teams{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .scoreTag{border:1px solid #26313c;border-radius:6px;padding:2px 6px;min-width:28px;text-align:center;font-weight:800}
  .fantPill{display:inline-flex;align-items:center;gap:8px;background:#0e1a14;border:1px solid var(--okBr);color:var(--ok);padding:6px 10px;border-radius:999px;font-weight:900}

  /* Spotlight layout */
  .spot{display:grid;grid-template-columns:1.25fr 0.9fr;gap:14px;align-items:start}
  @media (max-width:1100px){ .spot{grid-template-columns:1fr} }

  .teamline{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#0f1318;border:1px solid #1c2430}
  .teamline img{width:48px;height:48px;border-radius:10px;border:1px solid #1e2732;background:#0d1218}

  .scoreRow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:560px){ .scoreRow{grid-template-columns:1fr} }
  .scoreBox{text-align:center;background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}
  .scoreNum{font-size:42px;font-weight:900}

  .plays{max-height:34vh;overflow:auto;border:1px solid #1c2430;border-radius:10px;padding:8px;background:#0f1318}
  .play{padding:4px 0;border-bottom:1px dashed #1e2732}
  .play:last-child{border-bottom:0}

  /* Rink */
  .rinkWrap{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:10px}
  .rinkTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .rinkBox{width:100%;aspect-ratio:200/85} /* always visible on load */
  svg{width:100%;height:100%;display:block}
</style>
</head>
<body>
<header>
  <div class="bar wrap">
    <div style="display:flex;gap:10px;align-items:center">
      <a class="btn" href="index.html" title="Home">Home</a>
      <div>
        <div style="font-size:18px;font-weight:800">NHL Puck’Em — Viewer</div>
        <div class="sub">Week: <b id="wkPretty">—</b> · <span id="lastUpd" class="small">—</span></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="btnPause" class="btn" aria-pressed="false">⏸️ Pause Rotate</button>
      <button id="btnFS" class="btn" title="Fullscreen">Fullscreen</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:12px">
  <section class="card section">
    <h2>Top Games (Fantasy)</h2>
    <div id="topStrip" class="topStrip" aria-live="polite"></div>
  </section>

  <div class="sep"></div>

  <section class="spot">
    <!-- LEFT: Spotlight with RINK FIRST so it’s visible immediately -->
    <div class="card section" id="spotlight">
      <h2 style="display:flex;justify-content:space-between;align-items:center">
        <span id="spotTitle">Game Spotlight</span>
        <span class="small" id="spotState">—</span>
      </h2>

      <div class="sep"></div>

      <!-- RINK -->
      <section class="rinkWrap">
        <div class="rinkTop">
          <div class="small" style="font-weight:700">Rink (Live / Sim)</div>
          <label class="small" style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input id="simToggle" type="checkbox"> Simulate
          </label>
        </div>
        <div class="rinkBox">
          <!-- Accurate 200×85 rink -->
          <svg id="rink" viewBox="0 0 200 85" aria-label="Hockey rink">
            <defs>
              <clipPath id="rinkClip"><rect x="2" y="2" width="196" height="81" rx="22" ry="22"/></clipPath>
            </defs>
            <!-- Ice + boards -->
            <rect x="2" y="2" width="196" height="81" rx="22" ry="22" fill="#eef3f8" stroke="#cfd8e3" stroke-width="4"/>
            <!-- Center red line -->
            <line x1="100" y1="2" x2="100" y2="83" stroke="#d33" stroke-width="2"/>
            <!-- Blue lines: 25 ft (≈25/100*200=50) from center => at 75 & 125 -->
            <line x1="75" y1="2" x2="75" y2="83" stroke="#2b7bd1" stroke-width="2"/>
            <line x1="125" y1="2" x2="125" y2="83" stroke="#2b7bd1" stroke-width="2"/>
            <!-- Goal lines: 11 ft from end => at 11 & 189 -->
            <line x1="11" y1="2" x2="11" y2="83" stroke="#d33" stroke-width="2"/>
            <line x1="189" y1="2" x2="189" y2="83" stroke="#d33" stroke-width="2"/>

            <!-- Center circle + dot -->
            <circle cx="100" cy="42.5" r="15" fill="none" stroke="#2b7bd1" stroke-width="1.6"/>
            <circle cx="100" cy="42.5" r="1.7" fill="#2b7bd1"/>

            <!-- Offensive/defensive zone faceoff circles (x≈69 & 131, y≈21 and 64) -->
            <!-- Left zone -->
            <circle cx="69" cy="21" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
            <circle cx="69" cy="64" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
            <circle cx="69" cy="21" r="1.6" fill="#d33"/>
            <circle cx="69" cy="64" r="1.6" fill="#d33"/>
            <!-- Right zone -->
            <circle cx="131" cy="21" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
            <circle cx="131" cy="64" r="10.5" fill="none" stroke="#d33" stroke-width="1.6"/>
            <circle cx="131" cy="21" r="1.6" fill="#d33"/>
            <circle cx="131" cy="64" r="1.6" fill="#d33"/>

            <!-- Creases: 6 ft radius (≈6/100*200=12), depth clipped -->
            <path d="M13,42.5 a12,12 0 0 0 24,0" fill="#3aa3ff" fill-opacity="0.9" stroke="#2b7bd1" stroke-width="1.2"/>
            <path d="M187,42.5 a-12,12 0 0 0 -24,0" fill="#3aa3ff" fill-opacity="0.9" stroke="#2b7bd1" stroke-width="1.2"/>

            <!-- Goals touching goal line -->
            <rect x="9.2" y="39" width="1.8" height="7" fill="#2b7bd1" rx="0.5"/>
            <rect x="189" y="39" width="1.8" height="7" fill="#2b7bd1" rx="0.5"/>

            <!-- Puck -->
            <circle id="puck" cx="100" cy="42.5" r="2.6" fill="#111" stroke="#000" stroke-width="0.4" />
          </svg>
        </div>
      </section>

      <div class="sep"></div>

      <!-- Teams + score/clock below rink -->
      <div id="spotTeams"></div>
      <div class="sep"></div>

      <div class="scoreRow">
        <div class="scoreBox">
          <div class="small">Fantasy Score</div>
          <div id="spotFantasy" class="scoreNum">—</div>
          <div id="spotBonuses" class="small">—</div>
        </div>
        <div class="scoreBox">
          <div class="small">Game Clock</div>
          <div class="scoreNum" id="spotClock" style="font-size:36px">—</div>
          <div class="small">P<span id="spotPer">—</span></div>
        </div>
      </div>

      <div class="sep"></div>

      <!-- Latest plays -->
      <section class="panel" style="padding:10px">
        <div class="small" style="margin:0 0 6px 0;font-weight:700">Latest Plays</div>
        <div id="spotLog" class="plays"></div>
      </section>
    </div>

    <!-- RIGHT column: tips/controls -->
    <div class="card section">
      <h2>Controls</h2>
      <div class="sep"></div>
      <div class="small">Click any “Top Games” card to jump spotlight.</div>
      <div class="small" style="margin-top:8px">Press <span class="kbd">Space</span> to pause/resume rotation.</div>
      <div class="small" style="margin-top:8px">Press <span class="kbd">F</span> for fullscreen.</div>
    </div>
  </section>

  <div class="sep"></div>
  <div class="small">Feed live tracking with <code>window.setPuck({x:%, y:%})</code> (0–100 in rink %).</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ------- Supabase + week helpers ------- */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, { auth: { persistSession:false } });

const TZ='America/Chicago';
const parts=(d,opts)=>Object.fromEntries(new Intl.DateTimeFormat('en-US',opts).formatToParts(d).map(p=>[p.type,p.value]));
const nowCT=()=>new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
const addCT=(d,days)=>new Date(new Date(d.getTime()+days*86400000).toLocaleString('en-US',{timeZone:TZ}));
function weekKey(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const hour=+parts(n,{hour:'2-digit',hour12:false}).hour; const anchor=(hour>=8||days>0)?mon:addCT(mon,-7); const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}-Mon08CT`; }
function weekDates(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const list=[...Array(7)].map((_,i)=>{const d=addCT(mon,i); const p=parts(d,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}`}); const pM=parts(mon,{month:'2-digit',day:'2-digit'}); const pS=parts(addCT(mon,6),{month:'2-digit',day:'2-digit'}); return {list,pretty:`${pM.month}/${pM.day} → ${pS.month}/${pS/day}`}; }
const WEEK_KEY=weekKey(); const WEEK=weekDates(); const $=id=>document.getElementById(id);
$('wkPretty').textContent=WEEK.pretty;

/* ------- ESPN + DB helpers ------- */
const api={ scoreboard:(d)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard?dates=${d.replace(/-/g,'')}`, summary:(id)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${id}` };
const cdnNHL=t=>t?.logos?.[0]?.href?String(t.logos[0].href).replace(/^http:/,'https:'): (t?.abbreviation?`https://a.espncdn.com/i/teamlogos/nhl/500/${t.abbreviation}.png`:null);

async function getGameScore(gid){
  const { data } = await supa
    .from('game_scores')
    .select('total,home_pts,away_pts,close_bonus,ot_bonus,so_bonus')
    .eq('league','NHL').eq('week_key',WEEK_KEY).eq('game_id',String(gid)).maybeSingle();
  return data||null;
}

/* ------- State ------- */
const ST={ events:[], rows:[], idx:0, paused:false, spotId:null };
const stamp=()=>{ $('lastUpd').textContent='Updated ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };

/* ------- Rink puck control ------- */
function setPuckPercent(xPct,yPct){
  // map % (0–100) to SVG coords (viewBox 200x85)
  const cx = Math.max(0, Math.min(100, xPct)) * 2.0; // 0–200
  const cy = Math.max(0, Math.min(100, yPct)) * 0.85; // 0–85
  const puck = document.querySelector('#puck');
  if(puck){ puck.setAttribute('cx', cx.toFixed(2)); puck.setAttribute('cy', cy.toFixed(2)); }
}
window.setPuck = ({x,y}) => setPuckPercent(x,y); // live hook

let simTimer=null;
function startSim(){ stopSim(); let cx=50, cy=50;
  simTimer=setInterval(()=>{ cx+=(Math.random()-0.45)*5; cy+=(Math.random()-0.5)*3;
    cx=Math.max(1,Math.min(99,cx)); cy=Math.max(2,Math.min(98,cy));
    setPuckPercent(cx,cy);
  },500);
}
function stopSim(){ if(simTimer){ clearInterval(simTimer); simTimer=null; } }
$('simToggle').addEventListener('change',e=> e.target.checked?startSim():stopSim());

/* ------- Top strip + Spotlight ------- */
function tCard(r,g){
  return `
    <div class="tCard" data-gid="${r.id}" title="Open ${g.away.name} @ ${g.home.name}">
      <div class="teams">
        <div class="name" style="display:flex;align-items:center;gap:8px;min-width:0">
          ${g.away.logo?`<img src="${g.away.logo}" style="width:18px;height:18px;border-radius:4px;border:1px solid #1e2732;background:#0f1318">`:''}
          ${g.away.name} @ ${g.home.name}
          ${g.home.logo?`<img src="${g.home.logo}" style="width:18px;height:18px;border-radius:4px;border:1px solid #1e2732;background:#0f1318">`:''}
        </div>
        <div class="scoreTag">${Number(r.score||0).toFixed(2)}</div>
      </div>
      <div class="small">${r.status||''}</div>
      <div><span class="fantPill"><span>Fantasy</span><span>${Number(r.score||0).toFixed(2)}</span></span></div>
    </div>`;
}

function renderTopStrip(){
  const strip=$('topStrip');
  const top=ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  strip.innerHTML = top.map(r=>{
    const g=ST.events.find(e=>String(e.id)===String(r.id));
    return tCard(r,g);
  }).join('') || '<div class="small" style="padding:8px">—</div>';

  strip.querySelectorAll('[data-gid]').forEach(el=>{
    el.onclick=()=>{ ST.spotId=el.getAttribute('data-gid'); ST.paused=true; setPauseBtn(); openSpotlight(); document.getElementById('rink').scrollIntoView({behavior:'smooth',block:'center'}); };
  });
}
function setPauseBtn(){ $('btnPause').setAttribute('aria-pressed', ST.paused?'true':'false'); $('btnPause').textContent = ST.paused?'▶️ Resume Rotate':'⏸️ Pause Rotate'; }

async function openSpotlight(){
  const id = ST.spotId || (ST.rows[0]?.id);
  if(!id) return;
  const g = ST.events.find(e=>String(e.id)===String(id));
  if(!g) return;

  $('spotTitle').textContent = `${g.away.name} @ ${g.home.name}`;

  const s = await fetch(api.summary(id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
  const comp=s?.header?.competitions?.[0]||{};
  let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });

  const row = await getGameScore(id);

  $('spotTeams').innerHTML = `
    <div class="teamline" style="border-left:6px solid ${g.away.color?('#'+g.away.color):'#2a3643'}">
      <div style="display:flex;gap:10px;align-items:center">
        ${g.away.logo?`<img src="${g.away.logo}" alt="">`:''}
        <div style="font-weight:800">${g.away.name}</div>
      </div>
      <div style="font-weight:900">${row?.away_pts ?? (awayC?.score ?? 0)}</div>
    </div>
    <div class="teamline" style="border-left:6px solid ${g.home.color?('#'+g.home.color):'#2a3643'}">
      <div style="display:flex;gap:10px;align-items:center">
        ${g.home.logo?`<img src="${g.home.logo}" alt="">`:''}
        <div style="font-weight:800">${g.home.name}</div>
      </div>
      <div style="font-weight:900">${row?.home_pts ?? (homeC?.score ?? 0)}</div>
    </div>`;

  $('spotFantasy').textContent = (row?.total!=null?Number(row.total).toFixed(2):'—');
  const cb=Number(row?.close_bonus||0), ob=Number(row?.ot_bonus||0), sb=Number(row?.so_bonus||0);
  $('spotBonuses').textContent = `Bonuses: ${cb?`Close +${cb}`:'—'} · ${ob?`OT +${ob}`:'—'} · ${sb?`SO +${sb}`:'—'}`;

  $('spotClock').textContent = comp?.status?.displayClock || '—';
  $('spotPer').textContent   = comp?.status?.period ?? '—';
  $('spotState').textContent = comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—';
  document.getElementById('spotState').textContent = $('spotState').textContent;

  // latest plays
  const log=$('spotLog'); log.innerHTML='';
  (s?.scoringPlays||[]).slice(-14).reverse().forEach(sp=>{
    const t=(sp.clock?.displayValue||''), q=(sp.period?.number?'P'+sp.period.number:''), d=(sp.text||sp.description||'');
    const div=document.createElement('div'); div.className='play'; div.textContent=`[${q} ${t}] ${d}`; log.appendChild(div);
  });
}

async function loadWeek(){
  const all=[];
  for(const d of WEEK.list){
    const sb = await fetch(api.scoreboard(d),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const evs=sb?.events||[];
    for(const ev of evs){
      const c=ev.competitions?.[0]||{};
      let home=null,away=null; (c.competitors||[]).forEach(x=>{ if(x.homeAway==='home') home=x; if(x.homeAway==='away') away=x; });
      all.push({
        id:ev.id,
        start:ev.date,
        home:{ name:home?.team?(home.team.shortDisplayName||home.team.displayName):'Home', color:home?.team?.color||null, logo:cdnNHL(home?.team||null) },
        away:{ name:away?.team?(away.team.shortDisplayName||away.team.displayName):'Away', color:away?.team?.color||null, logo:cdnNHL(away?.team||null) }
      });
    }
  }
  all.sort((a,b)=>new Date(a.start)-new Date(b.start));
  ST.events=all;
}

async function refreshRows(){
  if(!ST.events.length) return;
  const batch = await Promise.all(ST.events.map(async g=>{
    const s = await fetch(api.summary(g.id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const row = await getGameScore(g.id);
    const comp=s?.header?.competitions?.[0]||{};
    let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });
    return {
      id:g.id,
      awayPts: row?.away_pts ?? Number(awayC?.score || 0),
      homePts: row?.home_pts ?? Number(homeC?.score || 0),
      score: row?.total ?? 0,
      status: (comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—')
    };
  }));
  ST.rows = batch.filter(Boolean);
  stamp();
}

function tickRotate(){
  if(ST.paused || ST.rows.length===0) return;
  const top = ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  if(!top.length) return;
  ST.idx = (ST.idx+1) % top.length;
  ST.spotId = top[ST.idx].id;
  openSpotlight();
}

/* Controls */
$('btnPause').onclick=()=>{ ST.paused=!ST.paused; setPauseBtn(); };
$('btnFS').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
document.addEventListener('keydown',e=>{
  if(e.key===' '){ e.preventDefault(); ST.paused=!ST.paused; setPauseBtn(); }
  if(e.key.toLowerCase()==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
});

/* Boot */
(async ()=>{
  await loadWeek();
  await refreshRows();
  renderTopStrip();
  ST.spotId = (ST.rows[0]?.id) || null;
  await openSpotlight();
  // ensure rink is visible when the page first loads
  document.getElementById('rink').scrollIntoView({behavior:'instant',block:'center'});
})();
</script>
</body>
</html>
