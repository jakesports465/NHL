<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Puck’Em — Viewer</title>
<link rel="preconnect" href="https://site.api.espn.com">
<style>
  :root{
    --bg:#0b0d10; --card:#12161b; --panel:#0f1318; --muted:#8ea0b3; --text:#e8eef4;
    --br:#1b232d; --ok:#9be7b0; --okBr:#2e5e3f; --accent2:#31506a;
  }

  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *,*::before,*::after{box-sizing:border-box}
  :focus-visible{outline:2px solid #3c82f6; outline-offset:2px; border-radius:8px}

  /* Sleek themed scrollbars */
  *{ scrollbar-width:thin; scrollbar-color:#334152 #0f1318 }
  *::-webkit-scrollbar{ width:10px; height:10px }
  *::-webkit-scrollbar-track{ background:#0f1318; border-left:1px solid #17202a }
  *::-webkit-scrollbar-thumb{ background:#334152; border:2px solid #0f1318; border-radius:12px }
  *::-webkit-scrollbar-thumb:hover{ background:#3f536b }

  .wrap{max-width:1300px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f1318,transparent);border-bottom:1px solid var(--br)}
  header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .sub{color:var(--muted)}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;min-height:42px}
  .btn[aria-pressed="true"]{background:#182633;border-color:var(--accent2)}
  .iconBtn{padding:8px 10px;min-height:auto}
  .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#cfe2f5;background:#0e1620;border:1px solid #243241;border-radius:8px;padding:6px 8px}

  .card{background:var(--card);border:1px solid var(--br);border-radius:14px}
  .panel{background:var(--panel);border:1px solid #1c2430;border-radius:14px}
  .section{padding:14px}
  h2{margin:0 0 10px 0}
  .small{font-size:13px;color:var(--muted)}
  .sep{height:1px;background:var(--br);margin:12px 0}

  /* Top strip — horizontally scrollable cards of best games */
  .topStrip{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(280px,1fr);gap:12px;overflow:auto;padding:12px}
  .tCard{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:10px;min-width:280px;display:grid;gap:6px;cursor:pointer}
  .teams{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .scoreTag{border:1px solid #26313c;border-radius:6px;padding:2px 6px;min-width:28px;text-align:center;font-weight:800}
  .fantPill{display:inline-flex;align-items:center;gap:8px;background:#0e1a14;border:1px solid var(--okBr);color:var(--ok);padding:6px 10px;border-radius:999px;font-weight:900}

  /* Spotlight layout */
  .spot{display:grid;grid-template-columns:1.25fr 0.9fr;gap:14px;align-items:start}
  @media (max-width:1100px){ .spot{grid-template-columns:1fr} }

  .teamline{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#0f1318;border:1px solid #1c2430}
  .teamline img{width:48px;height:48px;border-radius:10px;border:1px solid #1e2732;background:#0d1218}

  .scoreRow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:560px){ .scoreRow{grid-template-columns:1fr} }
  .scoreBox{text-align:center;background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}
  .scoreNum{font-size:42px;font-weight:900}

  /* Plays panel */
  .plays{max-height:34vh;overflow:auto;border:1px solid #1c2430;border-radius:10px;padding:8px;background:#0f1318}
  .play{padding:4px 0;border-bottom:1px dashed #1e2732}
  .play:last-child{border-bottom:0}

  /* Rink block */
  .rinkWrap{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:10px}
  .rinkTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .rink{position:relative;width:100%;aspect-ratio:200/85;background:#e8eef4;border-radius:24px;overflow:hidden;box-shadow:inset 0 0 0 6px #cfd8e3}
  .rink::before{
    content:"";position:absolute;inset:0;opacity:.9;
    background:
      radial-gradient(closest-side, transparent 0 96%, #cfd8e3 97% 100%) left/50% 100% no-repeat,
      radial-gradient(closest-side, transparent 0 96%, #cfd8e3 97% 100%) right/50% 100% no-repeat,
      linear-gradient(#c0392b,#c0392b) 50%/2px 100% no-repeat,
      linear-gradient(#2362c2,#2362c2) 25%/2px 100% no-repeat,
      linear-gradient(#2362c2,#2362c2) 75%/2px 100% no-repeat;
  }
  .puck{position:absolute;width:14px;height:14px;margin:-7px 0 0 -7px;border-radius:50%;background:#111;box-shadow:0 2px 4px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.15)}
  .zoneLabel{position:absolute;left:50%;transform:translateX(-50%);top:6px;font-weight:700;color:#2a3a4d;font-size:12px;opacity:.7}

  @media (prefers-reduced-motion:no-preference){
    .animate-enter{transition:opacity .2s ease, transform .2s ease}
    .animate-enter[data-show="true"]{opacity:1; transform:none}
    .animate-enter[data-show="false"]{opacity:.98; transform:translateY(2px)}
  }
</style>
</head>
<body>
<header>
  <div class="bar wrap">
    <div>
      <div style="font-size:18px;font-weight:800">NHL Puck’Em — Viewer</div>
      <div class="sub">Week: <b id="wkPretty">—</b> · <span id="lastUpd" class="small">—</span></div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="btnPause" class="btn" aria-pressed="false">⏸️ Pause Rotate</button>
      <button id="btnFS" class="btn iconBtn" title="Fullscreen">⛶</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:12px">
  <!-- Top Games strip (scrolling) -->
  <section class="card section">
    <h2>Top Games (Fantasy)</h2>
    <div id="topStrip" class="topStrip" aria-live="polite"></div>
  </section>

  <div class="sep"></div>

  <!-- Spotlight column + side info (no bottom grid) -->
  <section class="spot">
    <!-- Spotlight -->
    <div class="card section animate-enter" id="spotlight" data-show="false" style="display:block">
      <h2 style="display:flex;justify-content:space-between;align-items:center">
        <span id="spotTitle">Game Spotlight</span>
        <span class="small" id="spotState">—</span>
      </h2>

      <div class="sep"></div>
      <div id="spotTeams"></div>

      <div class="sep"></div>

      <div class="scoreRow">
        <div class="scoreBox">
          <div class="small">Fantasy Score</div>
          <div id="spotFantasy" class="scoreNum">—</div>
          <div id="spotBonuses" class="small">—</div>
        </div>
        <div class="scoreBox">
          <div class="small">Game Clock</div>
          <div class="scoreNum" id="spotClock" style="font-size:36px">—</div>
          <div class="small">P<span id="spotPer">—</span></div>
        </div>
      </div>

      <div class="sep"></div>

      <!-- Rink + Latest Plays stacked on narrow, side-by-side on wide -->
      <div class="spot" style="grid-template-columns:1.2fr 1fr">
        <section class="rinkWrap">
          <div class="rinkTop">
            <div class="small" style="font-weight:700">Rink (Live / Sim)</div>
            <label class="small" style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input id="simToggle" type="checkbox"> Simulate
            </label>
          </div>
          <div class="rink" id="rink">
            <div class="zoneLabel" id="zoneLbl">—</div>
            <div id="puck" class="puck" style="left:50%;top:50%"></div>
          </div>
        </section>

        <section class="panel" style="padding:10px">
          <div class="small" style="margin:0 0 6px 0;font-weight:700">Latest Plays</div>
          <div id="spotLog" class="plays"></div>
        </section>
      </div>
    </div>

    <!-- Right column: quick help / controls -->
    <div class="card section">
      <h2>Controls</h2>
      <div class="sep"></div>
      <div class="small">Click a card in “Top Games” to jump the spotlight.</div>
      <div class="small" style="margin-top:8px">Press <span class="kbd">Space</span> to pause/resume rotation.</div>
      <div class="small" style="margin-top:8px">Press <span class="kbd">F</span> for fullscreen.</div>
    </div>
  </section>

  <div class="sep"></div>
  <div class="small">Tip: the Top Games strip auto-updates; the spotlight rotates through the top-scoring fantasy games unless paused.</div>
</main>

<!-- Supabase (read-only) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ------- Config (reuse your keys) ------- */
const SUPA_URL  = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';
const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';
const supa = supabase.createClient(SUPA_URL, SUPA_ANON, { auth: { persistSession:false } });

/* ------- Week helpers (Mon 08:00 CT) ------- */
const TZ='America/Chicago';
const parts=(d,opts)=>Object.fromEntries(new Intl.DateTimeFormat('en-US',opts).formatToParts(d).map(p=>[p.type,p.value]));
const nowCT=()=>new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
const addCT=(d,days)=>new Date(new Date(d.getTime()+days*86400000).toLocaleString('en-US',{timeZone:TZ}));
function weekKey(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const hour=+parts(n,{hour:'2-digit',hour12:false}).hour; const anchor=(hour>=8||days>0)?mon:addCT(mon,-7); const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}-Mon08CT`; }
function weekDates(){ const n=nowCT(); const wd=n.getDay(); const days=(wd-1+7)%7; const mon=addCT(n,-days); const list=[...Array(7)].map((_,i)=>{const d=addCT(mon,i); const p=parts(d,{year:'numeric',month:'2-digit',day:'2-digit'}); return `${p.year}-${p.month}-${p.day}`}); const pM=parts(mon,{month:'2-digit',day:'2-digit'}); const pS=parts(addCT(mon,6),{month:'2-digit',day:'2-digit'}); return {list,pretty:`${pM.month}/${pM.day} → ${pS.month}/${pS.day}`}; }
const WEEK_KEY=weekKey(); const WEEK=weekDates();
const $=id=>document.getElementById(id);
$('wkPretty').textContent=WEEK.pretty;

/* ------- ESPN & CDN helpers ------- */
const api={ scoreboard:(d)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard?dates=${d.replace(/-/g,'')}`, summary:(id)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${id}` };
const cdnNHL=t=>t?.logos?.[0]?.href?String(t.logos[0].href).replace(/^http:/,'https:'): (t?.abbreviation?`https://a.espncdn.com/i/teamlogos/nhl/500/${t.abbreviation}.png`:null);

/* ------- DB helpers (read computed totals) ------- */
async function getGameScore(gid){
  const { data } = await supa
    .from('game_scores')
    .select('total,home_pts,away_pts,close_bonus,ot_bonus,so_bonus')
    .eq('league','NHL').eq('week_key',WEEK_KEY).eq('game_id',String(gid)).maybeSingle();
  return data||null;
}

/* ------- State ------- */
const ST={ events:[], rows:[], idx:0, paused:false, spotId:null };
const stamp=()=>{ $('lastUpd').textContent='Updated ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };

/* ------- Rink (puck) ------- */
function setPuckPercent(xPct,yPct){
  const x=Math.max(0,Math.min(100,xPct)), y=Math.max(0,Math.min(100,yPct));
  const puck=$('puck'), zone=$('zoneLbl');
  if(puck){ puck.style.left=x+'%'; puck.style.top=y+'%'; }
  let z='Neutral Zone'; if(x<33.33) z='Defensive Zone'; else if(x>66.66) z='Offensive Zone';
  if(zone) zone.textContent=z;
}
// public hook for real tracking feed:
window.setPuck = ({x,y}) => setPuckPercent(x,y);

let simTimer=null;
function startSim(){ stopSim(); let cx=50, cy=50;
  simTimer=setInterval(()=>{ cx+=(Math.random()-0.45)*5; cy+=(Math.random()-0.5)*3;
    if(cx<1||cx>99) cx = Math.max(1,Math.min(99,cx))*0.98 + (cx<1?2:-2);
    if(cy<2||cy>98) cy = Math.max(2,Math.min(98,cy))*0.98 + (cy<2?2:-2);
    setPuckPercent(cx,cy);
  },500);
}
function stopSim(){ if(simTimer){ clearInterval(simTimer); simTimer=null; } }
$('simToggle').addEventListener('change',e=> e.target.checked?startSim():stopSim());

/* ------- UI builders ------- */
function tCard(r,g){
  return `
    <div class="tCard" data-gid="${r.id}" title="Open ${g.away.name} @ ${g.home.name}">
      <div class="teams">
        <div class="name" style="display:flex;align-items:center;gap:8px;min-width:0">
          ${g.away.logo?`<img src="${g.away.logo}" style="width:18px;height:18px;border-radius:4px;border:1px solid #1e2732;background:#0f1318">`:''}
          ${g.away.name} @ ${g.home.name}
          ${g.home.logo?`<img src="${g.home.logo}" style="width:18px;height:18px;border-radius:4px;border:1px solid #1e2732;background:#0f1318">`:''}
        </div>
        <div class="scoreTag">${Number(r.score||0).toFixed(2)}</div>
      </div>
      <div class="small">${r.status||''}</div>
      <div><span class="fantPill"><span>Fantasy</span><span>${Number(r.score||0).toFixed(2)}</span></span></div>
    </div>`;
}

function renderTopStrip(){
  const strip=$('topStrip');
  const top=ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  strip.innerHTML = top.map(r=>{
    const g=ST.events.find(e=>String(e.id)===String(r.id));
    return tCard(r,g);
  }).join('') || '<div class="small" style="padding:8px">—</div>';

  strip.querySelectorAll('[data-gid]').forEach(el=>{
    el.onclick=()=>{ ST.spotId=el.getAttribute('data-gid'); ST.paused=true; setPauseBtn(); openSpotlight(); };
  });
}

function setPauseBtn(){
  $('btnPause').setAttribute('aria-pressed', ST.paused?'true':'false');
  $('btnPause').textContent = ST.paused?'▶️ Resume Rotate':'⏸️ Pause Rotate';
}

/* ------- Spotlight ------- */
async function openSpotlight(){
  const id = ST.spotId || (ST.rows[0]?.id);
  if(!id) return;
  const g = ST.events.find(e=>String(e.id)===String(id));
  if(!g) return;

  // scroll back to top when opening
  window.scrollTo({ top: 0, behavior: 'smooth' });

  $('spotTitle').textContent = `${g.away.name} @ ${g.home.name}`;

  const s = await fetch(api.summary(id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
  const comp=s?.header?.competitions?.[0]||{};
  let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });

  const row = await getGameScore(id);

  // Teams block
  $('spotTeams').innerHTML = `
    <div class="teamline" style="border-left:6px solid ${g.away.color?('#'+g.away.color):'#2a3643'}">
      <div style="display:flex;gap:10px;align-items:center">
        ${g.away.logo?`<img src="${g.away.logo}" alt="">`:''}
        <div style="font-weight:800">${g.away.name}</div>
      </div>
      <div style="font-weight:900">${row?.away_pts ?? (awayC?.score ?? 0)}</div>
    </div>
    <div class="teamline" style="border-left:6px solid ${g.home.color?('#'+g.home.color):'#2a3643'}">
      <div style="display:flex;gap:10px;align-items:center">
        ${g.home.logo?`<img src="${g.home.logo}" alt="">`:''}
        <div style="font-weight:800">${g.home.name}</div>
      </div>
      <div style="font-weight:900">${row?.home_pts ?? (homeC?.score ?? 0)}</div>
    </div>`;

  $('spotFantasy').textContent = (row?.total!=null?Number(row.total).toFixed(2):'—');
  const cb=Number(row?.close_bonus||0), ob=Number(row?.ot_bonus||0), sb=Number(row?.so_bonus||0);
  $('spotBonuses').textContent = `Bonuses: ${cb?`Close +${cb}`:'—'} · ${ob?`OT +${ob}`:'—'} · ${sb?`SO +${sb}`:'—'}`;

  $('spotClock').textContent = comp?.status?.displayClock || '—';
  $('spotPer').textContent   = comp?.status?.period ?? '—';
  $('spotState').textContent = comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—';

  // Latest scoring plays (yes: pulled from ESPN summary)
  const log=$('spotLog'); log.innerHTML='';
  (s?.scoringPlays||[]).slice(-14).reverse().forEach(sp=>{
    const t=(sp.clock?.displayValue||''), q=(sp.period?.number?'P'+sp.period.number:''), d=(sp.text||sp.description||'');
    const div=document.createElement('div'); div.className='play'; div.textContent=`[${q} ${t}] ${d}`; log.appendChild(div);
  });
}

/* ------- Data load ------- */
async function loadWeek(){
  const all=[];
  for(const d of WEEK.list){
    const sb = await fetch(api.scoreboard(d),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const evs=sb?.events||[];
    for(const ev of evs){
      const c=ev.competitions?.[0]||{};
      let home=null,away=null; (c.competitors||[]).forEach(x=>{ if(x.homeAway==='home') home=x; if(x.homeAway==='away') away=x; });
      all.push({
        id:ev.id,
        start:ev.date,
        home:{ name:home?.team?(home.team.shortDisplayName||home.team.displayName):'Home', color:home?.team?.color||null, logo:cdnNHL(home?.team||null) },
        away:{ name:away?.team?(away.team.shortDisplayName||away.team.displayName):'Away', color:away?.team?.color||null, logo:cdnNHL(away?.team||null) }
      });
    }
  }
  all.sort((a,b)=>new Date(a.start)-new Date(b.start));
  ST.events=all;
}

/* ------- Refresh fantasy/score rows ------- */
async function refreshRows(){
  if(!ST.events.length) return;
  const batch = await Promise.all(ST.events.map(async g=>{
    const s = await fetch(api.summary(g.id),{cache:'no-store'}).then(r=>r.json()).catch(()=>null);
    const row = await getGameScore(g.id);
    const comp=s?.header?.competitions?.[0]||{};
    let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });
    return {
      id:g.id,
      awayPts: row?.away_pts ?? Number(awayC?.score || 0),
      homePts: row?.home_pts ?? Number(homeC?.score || 0),
      score: row?.total ?? 0,
      status: (comp?.status?.type?.shortDetail || comp?.status?.type?.description || '—')
    };
  }));
  ST.rows = batch.filter(Boolean);
  stamp();
}

/* ------- Rotation ------- */
function tickRotate(){
  if(ST.paused || ST.rows.length===0) return;
  const top = ST.rows.slice().sort((a,b)=>b.score-a.score).slice(0,12);
  if(!top.length) return;
  ST.idx = (ST.idx+1) % top.length;
  ST.spotId = top[ST.idx].id;
  openSpotlight();
}

/* ------- Controls ------- */
$('btnPause').onclick=()=>{ ST.paused=!ST.paused; setPauseBtn(); };
$('btnFS').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
document.addEventListener('keydown',e=>{
  if(e.key===' '){ e.preventDefault(); ST.paused=!ST.paused; setPauseBtn(); }
  if(e.key.toLowerCase()==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
});

/* ------- Boot ------- */
(async ()=>{
  await loadWeek();
  await refreshRows();
  renderTopStrip();
  ST.spotId = (ST.rows[0]?.id) || null;
  await openSpotlight();

  // periodic refresh
  setInterval(async()=>{ await refreshRows(); renderTopStrip(); if(!ST.paused) await openSpotlight(); }, 30000);
  setInterval(tickRotate, 8000);
})();
</script>
</body>
</html>
