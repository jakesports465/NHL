-- ============================================
-- HOCKEY FANTASY: DB HARDENING (SQL-ONLY PACK)
-- Safe to run multiple times (idempotent-ish)
-- ============================================

-- 0) EXTENSIONS (optional but nice to have)
-- Uncomment if your project allows CREATE EXTENSION
-- create extension if not exists pgcrypto;
-- create extension if not exists btree_gin;

-- ===================================================
-- 1) TABLES (create if missing) + NOT NULL hardening
-- ===================================================

-- players: stores display names
create table if not exists public.players (
  id uuid primary key,
  display_name text,
  created_at timestamptz default now()
);

-- picks: user picks per league/week/game
create table if not exists public.picks (
  user_id uuid not null,
  league text not null,
  week_key text not null,
  game_id text not null,
  created_at timestamptz default now()
);

-- season_points: weekly awards snapshot (Top10 10..1)
create table if not exists public.season_points (
  user_id uuid not null,
  league text not null,
  week_key text not null,
  points int not null,
  created_at timestamptz default now()
);

-- Harden NOT NULLs (won’t error if already true)
alter table public.players
  alter column id set not null;

alter table public.picks
  alter column user_id set not null,
  alter column league set not null,
  alter column week_key set not null,
  alter column game_id set not null;

alter table public.season_points
  alter column user_id set not null,
  alter column league set not null,
  alter column week_key set not null,
  alter column points set not null;

-- ===========================================
-- 2) DATA CLEANUP BEFORE ADDING CONSTRAINTS
--    - Remove duplicate picks (keep earliest)
--    - Remove duplicate season_points (keep the
--      one with the HIGHEST points)
-- ===========================================

-- Dedup picks on (user_id, league, week_key, game_id)
with dups as (
  select
    user_id, league, week_key, game_id,
    created_at,
    row_number() over (partition by user_id, league, week_key, game_id order by created_at asc, ctid asc) as rn
  from public.picks
)
delete from public.picks p
using dups d
where p.user_id = d.user_id
  and p.league = d.league
  and p.week_key = d.week_key
  and p.game_id = d.game_id
  and p.created_at = d.created_at
  and d.rn > 1;

-- Dedup season_points on (user_id, league, week_key), keep highest points
with ranked as (
  select
    user_id, league, week_key, points, created_at,
    row_number() over (partition by user_id, league, week_key order by points desc, created_at asc, ctid asc) as rn
  from public.season_points
)
delete from public.season_points s
using ranked r
where s.user_id = r.user_id
  and s.league = r.league
  and s.week_key = r.week_key
  and s.points = r.points
  and s.created_at = r.created_at
  and r.rn > 1;

-- ===========================================
-- 3) PRIMARY KEYS / UNIQUE CONSTRAINTS
-- ===========================================

-- picks uniqueness
do $$
begin
  if not exists (
    select 1 from pg_constraint
    where conname = 'picks_pkey'
  ) then
    alter table public.picks
      add constraint picks_pkey primary key (user_id, league, week_key, game_id);
  end if;
end$$;

-- season_points uniqueness (one award row per user/week/league)
do $$
begin
  if not exists (
    select 1 from pg_constraint
    where conname = 'season_points_pkey'
  ) then
    alter table public.season_points
      add constraint season_points_pkey primary key (user_id, league, week_key);
  end if;
end$$;

-- ===========================================
-- 4) INDEXES (speed up boards/reads)
-- ===========================================
create index if not exists picks_league_week_idx
  on public.picks (league, week_key);

create index if not exists picks_user_league_week_idx
  on public.picks (user_id, league, week_key);

create index if not exists season_points_league_week_idx
  on public.season_points (league, week_key);

-- ===========================================
-- 5) RLS: Enable + Policies
--     - players: public read; owner write
--     - picks:   public read; owner write
--     - season_points: public read; insert allowed
--       to any authenticated user (matches your
--       current client awards routine), but no
--       UPDATE/DELETE.
-- ===========================================

alter table public.players enable row level security;
alter table public.picks enable row level security;
alter table public.season_points enable row level security;

-- players policies
drop policy if exists players_select on public.players;
create policy players_select on public.players
for select using (true);

drop policy if exists players_upsert on public.players;
create policy players_upsert on public.players
for insert with check (id = auth.uid());

drop policy if exists players_update on public.players;
create policy players_update on public.players
for update using (id = auth.uid()) with check (id = auth.uid());

-- picks policies
drop policy if exists picks_select on public.picks;
create policy picks_select on public.picks
for select using (true);

drop policy if exists picks_insert on public.picks;
create policy picks_insert on public.picks
for insert with check (user_id = auth.uid());

drop policy if exists picks_update on public.picks;
create policy picks_update on public.picks
for update using (user_id = auth.uid()) with check (user_id = auth.uid());

drop policy if exists picks_delete on public.picks;
create policy picks_delete on public.picks
for delete using (user_id = auth.uid());

-- season_points policies
drop policy if exists season_points_select on public.season_points;
create policy season_points_select on public.season_points
for select using (true);

-- Allow INSERT from any authenticated user. This aligns
-- with your client (which inserts multiple users’ awards).
-- PK prevents duplicates; no UPDATE/DELETE allowed.
drop policy if exists season_points_insert on public.season_points;
create policy season_points_insert on public.season_points
for insert to authenticated
with check (true);

-- Explicitly disallow updates/deletes (no policy created).

-- ===========================================
-- 6) BUSINESS RULE: Max 5 picks per user/week/league
--     Enforced with trigger at the DB layer.
-- ===========================================

create or replace function public.can_add_pick(_user uuid, _league text, _week text)
returns boolean
language sql stable as $$
  select count(*) < 5
  from public.picks
  where user_id = _user
    and league  = _league
    and week_key= _week;
$$;

create or replace function public.tg_enforce_max5_picks()
returns trigger
language plpgsql as $$
begin
  if not public.can_add_pick(new.user_id, new.league, new.week_key) then
    raise exception 'Max picks (5) reached for this league/week';
  end if;
  return new;
end;
$$;

drop trigger if exists enforce_max5_picks on public.picks;
create trigger enforce_max5_picks
before insert on public.picks
for each row execute function public.tg_enforce_max5_picks();

-- ===========================================
-- DONE.
-- Notes:
-- - Client awards can still insert into season_points.
-- - PK on season_points guarantees idempotency.
-- - Picks are now hard-limited to 5/week/league in DB.
-- - Public read preserved for boards & “Everyone’s Picks”.
-- ===========================================
