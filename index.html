<div><br class="Apple-interchange-newline"><!doctype html><br><html lang="en"><br><head><br><meta charset="utf-8" /><br><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" /><br><title>Hockey Fantasy — NHL (Mon→Sun · 5 picks)</title><br><style><br> :root{ --bg:#0b0d10; --card:#12161b; --muted:#8ea0b3; --text:#e8eef4; --br:#1b232d }<br> html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-text-size-adjust:100%}<br> *,*::before,*::after{box-sizing:border-box}<br> :focus-visible{outline:2px solid #3c82f6; outline-offset:2px; border-radius:8px}<br> @media (prefers-reduced-motion:no-preference){.animate-enter{transition:opacity .2s ease, transform .2s ease}.animate-enter[data-show="true"]{opacity:1; transform:none}.animate-enter[data-show="false"]{opacity:.98; transform:translateY(2px)}}<br> header{padding:14px 18px;border-bottom:1px solid var(--br);background:#0f1318;position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;flex-wrap:wrap}<br> h1{margin:0;font-size:18px}<br> .sub{color:var(--muted);font-size:13px;margin-left:6px}<br> .pill{border:1px dashed #364353;border-radius:999px;padding:4px 10px;font-size:12px;white-space:nowrap}<br> nav.tabs{display:flex;gap:8px;padding:10px 18px;background:#0f1318;border-bottom:1px solid #1b232d;position:sticky;top:56px;z-index:19;overflow-x:auto;scrollbar-width:none}<br> nav.tabs::-webkit-scrollbar{display:none}<br> .tab{padding:10px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px;flex:0 0 auto}<br> .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}<br> .section{display:none}<br> .section.active{display:block}<br> main{max-width:1160px;margin:0 auto;padding:16px 18px 46px}<br> .card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:14px}<br> .panel{background:#0f1318;border:1px solid var(--br);border-radius:12px;padding:12px}<br> .sep{height:1px;background:var(--br);margin:12px 0}<br> .small{font-size:12px;color:var(--muted)}<br> .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font-size:13px;line-height:1;min-height:40px}<br> .btn.small{padding:8px 10px;font-size:12px;min-height:36px}<br> .btn[disabled]{opacity:.6;cursor:not-allowed}<br> .gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}<br> .gameCard{background:#11171e;border:1px solid #1f2a36;border-radius:14px;overflow:hidden}<br> .band{height:6px}<br> .gameBody{padding:12px}<br> .teamsRow{display:flex;align-items:center;justify-content:space-between;gap:8px}<br> .team{display:flex;align-items:center;gap:8px;min-width:0}<br> .team img{width:22px;height:22px;border-radius:6px;border:1px solid #1e2732;background:#0f1318}<br> .team .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}<br> .scoreTag{display:inline-block;margin-left:6px;padding:2px 6px;border:1px solid #26313c;border-radius:6px;font-weight:700;min-width:24px;text-align:center}<br> .lockRow{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}<br> .pickedTag{display:inline-flex;align-items:center;gap:6px;border:1px solid #2e5e3f;background:#0e1a14;color:#9be7b0;border-radius:999px;padding:6px 10px;font-size:12px}<br> .topGrid{display:grid;grid-template-columns:1fr 240px 240px;gap:14px;align-items:start}<br> @media(max-width:980px){.topGrid{grid-template-columns:1fr}}<br> .teamline{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:#0f1318;border:1px solid #1c2430}<br> .teamline img{width:44px;height:44px;border-radius:8px;border:1px solid #1e2732;background:#0d1218}<br> .statusBox,.scoreBox{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}<br> .scoreBox{text-align:center}<br> .scoreBox .num{font-size:38px;font-weight:900}<br> .log{max-height:260px;overflow:auto;background:#0f1318;border-radius:10px;padding:8px;border:1px solid #1b232d;-webkit-overflow-scrolling:touch}<br> .lbHeaderRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:10px;flex-wrap:wrap}<br> .lbRow{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid #1c2430;background:#0f1318;margin-bottom:8px}<br> .lbPos{width:42px;text-align:center;font-weight:900;border:1px solid #26313c;border-radius:8px;padding:4px 0;opacity:.95}<br> .lbTeam{display:flex;gap:10px;align-items:center;min-width:0}<br> .lbTeam img{width:20px;height:20px;border-radius:4px;border:1px solid #1c2330;background:#0d1218;flex:0 0 auto}<br> .lbName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}<br> .lbPts{font-weight:800}<br> .field{display:flex;gap:8px;align-items:center;flex-wrap:wrap}<br> input[type="text"], input[type="email"]{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:10px;min-height:40px}<br> .badge{display:inline-block;background:#101722;border:1px solid #253548;border-radius:8px;padding:2px 6px}<br> @media (max-width: 900px){main{padding:14px 14px 40px}.card{padding:12px}.panel{padding:10px}.gamesGrid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}.scoreBox .num{font-size:34px}.teamline img{width:40px;height:40px}.log{max-height:38vh}}<br> @media (max-width: 720px){h1{font-size:16px}.sub{display:block;margin:2px 0 0 0}.pill{margin-left:0}.small{font-size:12px}.gamesGrid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}.lbRow{grid-template-columns:auto 1fr auto; row-gap:6px}.lbRow .small{grid-column:1 / -1; justify-self:start}<br> .lockRow .btn{flex:1 1 auto}<br> input[type="text"], input[type="email"]{font-size:16px}<br> header{padding-top:calc(14px + env(safe-area-inset-top))}<br> }<br> .rules{display:grid;gap:8px}<br> .rules .r{display:flex;justify-content:space-between;gap:12px;padding:8px;border:1px solid #1c2430;background:#0f1318;border-radius:10px}<br></style><br></head><br><body><br><header><br> <h1>Hockey Fantasy <span class="sub">NHL · Mon→Sun · 5 picks</span></h1><br> <span id="picksLeft" class="pill">Sign in to play</span><br> <span class="small" style="margin-left:auto">Week: <b id="weekLabel">—</b></span><br> <div id="authBox" class="field" style="margin-left:auto;gap:6px"><br> <form id="loginForm" class="field" style="gap:6px"><br> <input id="emailInput" type="email" placeholder="your@email.com" required><br> <button class="btn small" type="submit">Send magic link</button><br> </form><br> <div id="userBox" class="field" style="display:none;gap:6px"><br> <span class="small" id="whoami">—</span><br> <input id="displayNameInput" type="text" placeholder="Display name" style="max-width:180px"><br> <button id="saveDisplayName" class="btn small" type="button">Save</button><br> <button id="logoutBtn" class="btn small" type="button">Sign out</button><br> </div><br> </div><br></header><br><nav class="tabs" role="tablist" aria-label="Sections"><br> <button class="tab" id="tab-nhl" role="tab" aria-controls="sec-nhl" aria-selected="true">NHL</button><br> <button class="tab" id="tab-mine" role="tab" aria-controls="sec-mine" aria-selected="false">My Picks</button><br> <button class="tab" id="tab-lb" role="tab" aria-controls="sec-lb" aria-selected="false">Leaderboards</button><br> <button class="tab" id="tab-rules" role="tab" aria-controls="sec-rules" aria-selected="false">Scoring</button><br></nav><br><br><section id="sec-nhl" class="section active" aria-labelledby="tab-nhl"><br> <main><br> <section id="nhl-top" class="card animate-enter" data-show="false" style="display:none"><br> <div class="small" id="nhl-liveHeader">—</div><br> <div class="topGrid" style="margin-top:8px"><br> <div id="nhl-teamSide"></div><br> <div class="scoreBox"><br> <div class="small" style="margin-bottom:4px">Fantasy Score</div><br> <div id="nhl-fscore" class="num">—</div><br> <div id="nhl-bonuses" class="small">—</div><br> </div><br> <div class="statusBox"><br> <div class="small" style="margin-bottom:4px">Game Status</div><br> <div class="small">Clock: <b id="nhl-clock">—</b></div><br> <div class="small">Period: <b id="nhl-q">—</b></div><br> <div class="small">State: <b id="nhl-state">—</b></div><br> </div><br> </div><br> <div class="sep"></div><br> <div class="lockRow"><br> <button id="nhl-back" class="btn small">← Back to games</button><br> <button id="nhl-addPick" class="btn small">Add to my picks</button><br> </div><br> <div class="sep"></div><br> <h3 style="margin:0 0 6px 0">Recent Scoring Plays</h3><br> <div id="nhl-log" class="log"></div><br> <div class="sep"></div><br> <section class="panel"><br> <h3 style="margin:0 0 6px 0">Top Games — Fantasy (Top 15)</h3><br> <div id="nhl-gameLB"></div><br> </section><br> <div class="sep"></div><br> <section class="panel"><br> <h3 style="margin:0 0 6px 0">Current User Standings — This Week</h3><br> <div id="nhl-userLB"></div><br> </section><br> </section><br> <section id="nhl-gridCard" class="card"><br> <div class="small" id="nhl-note">Loading NHL week…</div><br> <div class="sep"></div><br> <div id="nhl-grid" class="gamesGrid"></div><br> </section><br> </main><br></section><br><br><section id="sec-mine" class="section" aria-labelledby="tab-mine"><br> <main class="card"><br> <div class="lbHeaderRow"><br> <h2 style="margin:0">My Picks</h2><br> <span class="small">Week: <b id="mineWeekLabel">—</b></span><br> </div><br> <div class="sep"></div><br> <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start"><br> <section class="panel"><br> <h3 style="margin:0 0 6px 0">NHL — My Picks <span id="myNHLTotal" class="badge">0.00</span></h3><br> <div id="myNHL"></div><br> </section><br> <section class="panel"><br> <h3 style="margin:0 0 6px 0">Everyone’s Picks — This Week</h3><br> <div id="allPicks"></div><br> </section><br> </div><br> </main><br></section><br><br><section id="sec-lb" class="section" aria-labelledby="tab-lb"><br> <main class="card"><br> <div class="lbHeaderRow"><br> <h2 style="margin:0">Leaderboards</h2><br> </div><br> <div class="small" id="lbWeekLabel" style="margin-bottom:8px">—</div><br> <div class="sep"></div><br> <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><br> <section class="panel"><br> <h3 style="margin:0 0 6px 0">NHL — This Week</h3><br> <div id="lbNHLWeek"></div><br> </section><br> <section class="panel"><br> <h3 style="margin:0 0 6px 0">NHL — Season</h3><br> <div id="lbNHLSeason"></div><br> </section><br> </div><br> </main><br></section><br><br><section id="sec-rules" class="section" aria-labelledby="tab-rules"><br> <main class="card"><br> <h2 style="margin:0 0 10px 0">Scoring Rules (Game-based)</h2><br> <div class="small" style="margin-bottom:8px">Bonuses are capped to keep thrillers competitive with blowouts.</div><br> <div class="rules"><br> <div class="r"><span>Goal</span><b>+4</b></div><br> <div class="r"><span>Power-Play Goal (bonus)</span><b>+1.5</b></div><br> <div class="r"><span>Short-Handed Goal (bonus)</span><b>+2</b></div><br> <div class="r"><span>Shot on Goal (combined, both teams)</span><b>+0.1</b></div><br> <div class="r"><span>Goalie Saves (combined)</span><b>+0.02</b></div><br> <div class="r"><span>Hits (combined)</span><b>+0.1</b></div><br> <div class="r"><span>Blocked Shots (combined)</span><b>+0.1</b></div><br> <div class="r"><span>Penalty Minutes (combined)</span><b>−0.25 / min</b></div><br> <div class="r"><span>Close Game (final margin ≤ 1)</span><b>+8</b></div><br> <div class="r"><span>Overtime Played</span><b>+10</b></div><br> <div class="r"><span>Shootout Played</span><b>+6</b></div><br> <div class="r"><span>Bonus Cap (Close + OT + SO)</span><b>≤ +20 total</b></div><br> </div><br> </main><br></section><br><br><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><br><script><br>/* ---------- CONFIG ---------- */<br>const SUPA_URL = 'https://acmqdokxwnkkjmfgfyhh.supabase.co';<br>const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w';<br>const supa = supabase.createClient(SUPA_URL, SUPA_ANON, {<br> auth: { persistSession: true, detectSessionInUrl: true, flowType: 'pkce' }<br>});<br><br>/* ---------- PERF helpers ---------- */<br>const TZ='America/Chicago';<br>const MAX_PICKS=5;<br>const $ = id => document.getElementById(id);<br>const PERF_NS = `hf:${new Date().toISOString().slice(0,10)}`;<br>const L1 = new Map();<br>function k(ns){ return `${PERF_NS}:${ns}`; }<br>function getCache(ns){<br> const key=k(ns);<br> if(L1.has(key)) return L1.get(key);<br> try{<br> const raw=localStorage.getItem(key);<br> if(!raw) return null;<br> const obj=JSON.parse(raw);<br> if(obj.exp && Date.now()>obj.exp){ localStorage.removeItem(key); return null; }<br> L1.set(key,obj.val);<br> return obj.val;<br> }catch{ return null; }<br>}<br>function setCache(ns,val,ttlMs){<br> const key=k(ns);<br> L1.set(key,val);<br> try{ localStorage.setItem(key, JSON.stringify({val,exp: ttlMs?Date.now()+ttlMs:null})); }catch{}<br>}<br>function delCache(ns){ try{ localStorage.removeItem(k(ns)); }catch{} L1.delete(k(ns)); }<br><br>const INFLIGHT = new Map();<br>async function dedupFetch(url){<br> if(INFLIGHT.has(url)) return INFLIGHT.get(url);<br> const p = fetch(url,{cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); })<br> .finally(()=>INFLIGHT.delete(url));<br> INFLIGHT.set(url,p);<br> return p;<br>}<br>async function safeJson(url,retries=2){<br> for(let i=0;i<=retries;i++){<br> try{ return await dedupFetch(url); }<br> catch(e){ if(i===retries) throw e; await new Promise(r=>setTimeout(r,500*(i+1))); }<br> }<br>}<br>async function pLimitAll(items, limit, worker){<br> const out=new Array(items.length); let i=0, active=0;<br> return await new Promise(resolve=>{<br> const pump=()=>{<br> while(active<limit && i<items.length){<br> const idx=i++; active++;<br> Promise.resolve(worker(items[idx],idx))<br> .then(v=>{ out[idx]=v; })<br> .catch(()=>{ out[idx]=undefined; })<br> .finally(()=>{ active--; (i>=items.length && active===0)?resolve(out):pump(); });<br> }<br> };<br> pump();<br> });<br>}<br><br>/* ---------- Week logic (Mon 08:00 CT) ---------- */<br>function nowCT(){ return new Date(new Date().toLocaleString('en-US',{timeZone:TZ})); }<br>function addDaysCT(d,days){ const n=new Date(d.getTime()); n.setDate(n.getDate()+days); return new Date(n.toLocaleString('en-US',{timeZone:TZ})); }<br>function parts(d,opts){ const p=new Intl.DateTimeFormat('en-US',opts).formatToParts(d); const o={}; p.forEach(x=>o[x.type]=x.value); return o; }<br><br>/* Anchor week to Monday 08:00 CT */<br>function weekKey(){<br> const n=nowCT();<br> const wd=n.getDay(); /* Sun 0 ... Sat 6 */<br> const daysSinceMon=(wd-1+7)%7;<br> const mon=addDaysCT(n,-daysSinceMon);<br> const hour=Number(parts(n,{hour:'2-digit',hour12:false}).hour);<br> const after8 = hour>=8 || daysSinceMon>0;<br> const anchor = after8? mon : addDaysCT(mon,-7);<br> const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'});<br> return `${p.year}-${p.month}-${p.day}-Mon08CT`;<br>}<br><br>/* Derive dates from WEEK_KEY so labels always match storage (no drift) */<br>function weekDates(){<br> const [Y,M,D] = weekKey().split('-'); // YYYY, MM, DD, Mon08CT<br> const startLocal = new Date(`${Y}-${M}-${D}T08:00:00`);<br> const mon = new Date(startLocal.toLocaleString('en-US',{timeZone:TZ}));<br> const list=[];<br> for(let i=0;i<7;i++){<br> const d=new Date(mon.getTime()); d.setDate(mon.getDate()+i);<br> const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');<br> list.push(`${d.getFullYear()}-${mm}-${dd}`);<br> }<br> const pretty = `${list[0].slice(5).replace('-','/')} → ${list[6].slice(5).replace('-','/')}`;<br> return { list, start:list[0], end:list[6], pretty };<br>}<br><br>/* Helper to compute a week key from any CT date (week anchored to that Monday 08:00) */<br>function weekKeyFromDate(ctDate){<br> const wd=ctDate.getDay();<br> const daysSinceMon=(wd-1+7)%7;<br> const mon=addDaysCT(ctDate,-daysSinceMon);<br> const p=parts(mon,{year:'numeric',month:'2-digit',day:'2-digit'});<br> return `${p.year}-${p.month}-${p.day}-Mon08CT`;<br>}<br>/* Last week's key, relative to now */<br>function prevWeekKey(){<br> const n=nowCT();<br> const prev=addDaysCT(n,-7);<br> return weekKeyFromDate(prev);<br>}<br><br>const WEEK_KEY=weekKey(); const WEEK=weekDates();<br>$('weekLabel').textContent=WEEK.pretty; $('lbWeekLabel').textContent=`Week: ${WEEK.pretty}`; $('mineWeekLabel').textContent=WEEK.pretty;<br><br>/* ---------- ESPN helpers ---------- */<br>function cdnNHL(t){ if(!t) return null; if(t.logos?.[0]?.href) return String(t.logos[0].href).replace(/^http:/,'https:'); if(t.abbreviation) return `https://a.espncdn.com/i/teamlogos/nhl/500/${t.abbreviation}.png`; return null; }<br><br>/* ---------- Fantasy weights ---------- */<br>const H={ GOAL:4, PPG:1.5, SHG:2, SOG:0.1, SAVE:0.02, HIT:0.1, BLOCK:0.1, PIM:-0.25, CLOSE_GAME:8, OT:10, SO:6, BONUS_CAP:20 };<br><br>/* parse scoring using only the Summary endpoint */<br>function parseNHL(summary){<br> const comp = summary?.header?.competitions?.[0]||{};<br> let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });<br> const homePts=Number(homeC?.score??0), awayPts=Number(awayC?.score??0);<br> const isFinal = (comp.status?.type?.state==='post' || comp.status?.type?.completed===true);<br> const period = Number(comp.status?.period||0);<br> const isSO = isFinal && /SO/.test(String(comp.status?.type?.shortDetail||''));<br><br> const teams = summary?.boxscore?.teams||[];<br> let shots=0, saves=0, hits=0, blocks=0, pim=0, ppg=0, shg=0;<br> const find=(arr,k)=>arr?.find(s=>s.name===k||s.abbreviation===k)||null;<br> const v=(x)=>Number(x?.value??x?.displayValue??0)||0;<br> for(const tm of teams){<br> const st=tm.statistics||[];<br> shots += v(find(st,'shotsOnGoal'));<br> saves += v(find(st,'saves'));<br> hits += v(find(st,'hits'));<br> blocks+= v(find(st,'blockedShots'));<br> pim += v(find(st,'pim'));<br> }<br> const sps=summary?.scoringPlays||[];<br> const goals=sps.length;<br> for(const sp of sps){ const d=String(sp.text||sp.description||'').toLowerCase(); if(d.includes('power play')) ppg++; if(d.includes('short-handed')||d.includes('shorthanded')) shg++; }<br><br> const offense = goals*H.GOAL + ppg*H.PPG + shg*H.SHG + shots*H.SOG;<br> const defense = saves*H.SAVE + hits*H.HIT + blocks*H.BLOCK + pim*H.PIM;<br> const closeBonus = (isFinal && Math.abs(homePts-awayPts)<=1) ? H.CLOSE_GAME : 0;<br> const otBonus = (isFinal && period>3) ? H.OT : 0;<br> const soBonus = (isSO) ? H.SO : 0;<br> const bonus = Math.min(closeBonus+otBonus+soBonus, H.BONUS_CAP);<br> const total = offense + defense + bonus;<br> return { total:Number(total.toFixed(2)), homePts, awayPts, isFinal, bonus, closeBonus, otBonus, soBonus };<br>}<br><br>/* ---------- Supabase helpers ---------- */<br>let session=null, currentUser=null, displayName='';<br>function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'#0f1318',border:'1px solid #264',padding:'8px 10px',borderRadius:'10px',zIndex:50}); document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }<br>async function loadOrCreatePlayer(){<br> if(!currentUser) return;<br> const uid=currentUser.id;<br> const { data, error } = await supa.from('players').select('*').eq('id',uid).maybeSingle();<br> if(error){ console.error(error); return; }<br> if(!data){<br> const def = (currentUser.email||'user').split('@')[0];<br> const { error:insErr } = await supa.from('players').insert({ id:uid, display_name:def });<br> if(insErr){ console.error(insErr); }<br> displayName=def;<br> }else{<br> displayName=data.display_name||'';<br> }<br> $('displayNameInput').value=displayName||'';<br>}<br>$('saveDisplayName').addEventListener('click', async ()=>{<br> if(!currentUser) return;<br> const name = ($('displayNameInput').value||'').trim();<br> if(!name) return;<br> const { error } = await supa.from('players').upsert({ id: currentUser.id, display_name: name });<br> if(!error){ displayName=name; toast('Saved ✓'); renderWeeklyBoards(); renderSeasonBoards(); }<br>});<br>$('logoutBtn').addEventListener('click', async ()=>{ await supa.auth.signOut(); location.reload(); });<br>$('loginForm').addEventListener('submit', async (e)=>{<br> e.preventDefault();<br> const email=$('emailInput').value.trim();<br> if(!email) return;<br> const redirectTo = window.location.href;<br> const { error } = await supa.auth.signInWithOtp({ email, options:{emailRedirectTo: redirectTo, shouldCreateUser:true } });<br> if(error){ alert(error.message); return; }<br> toast('Magic link sent! Check your email.');<br>});<br><br>/* ---------- Picks (cached) ---------- */<br>function uniqLimit(arr){ const out=[]; const seen=new Set(); (arr||[]).forEach(x=>{ const id=String(x); if(!seen.has(id)){ seen.add(id); out.push(id); } }); return out.slice(0,MAX_PICKS); }<br>const CK_MY = uid => `picks:${WEEK_KEY}:${uid}`;<br>const CK_ALL = `allpicks:${WEEK_KEY}`;<br>const NAME_MEMO = new Map();<br><br>async function picksForUser(uid){<br> const ck = CK_MY(uid);<br> const cached = getCache(ck);<br> if(cached) return cached;<br> const { data, error } = await supa.from('picks')<br> .select('game_id')<br> .eq('user_id', uid)<br> .eq('league','NHL')<br> .eq('week_key', WEEK_KEY);<br> const list = error ? [] : uniqLimit((data||[]).map(r=>String(r.game_id)));<br> setCache(ck, list, 15000);<br> return list;<br>}<br>async function setPick(uid, gameId){<br> const { error } = await supa.from('picks').upsert(<br> [{ user_id: uid, league:'NHL', week_key: WEEK_KEY, game_id: String(gameId) }],<br> { onConflict: 'user_id,league,week_key,game_id' }<br> );<br> if(error){ alert(error.message); return false; }<br> delCache(CK_MY(uid)); delCache(CK_ALL);<br> return true;<br>}<br>async function allPicksThisWeek(){<br> const cached = getCache(CK_ALL);<br> if(cached) return cached;<br> const { data, error } = await supa.from('picks')<br> .select('user_id, game_id')<br> .eq('league','NHL')<br> .eq('week_key',WEEK_KEY);<br> const rows = error ? [] : (data||[]);<br> setCache(CK_ALL, rows, 20000);<br> return rows;<br>}<br>/* generic “picks for any week” for awarder */<br>async function allPicksForWeek(weekKeyArg){<br> const { data, error } = await supa.from('picks')<br> .select('user_id, game_id')<br> .eq('league','NHL')<br> .eq('week_key',weekKeyArg);<br> return error ? [] : (data||[]);<br>}<br><br>async function getDisplayNames(userIds){<br> const ids = [...new Set(userIds||[])].filter(Boolean);<br> if(ids.length===0) return {};<br> const need = ids.filter(id=>!NAME_MEMO.has(id));<br> if(need.length){<br> const { data, error } = await supa.from('players').select('id,display_name').in('id', need);<br> if(!error && data){<br> data.forEach(r=>NAME_MEMO.set(r.id, r.display_name || r.id.slice(0,6)));<br> need.forEach(id=>{ if(!NAME_MEMO.has(id)) NAME_MEMO.set(id, id.slice(0,6)); });<br> }else{<br> need.forEach(id=>NAME_MEMO.set(id, id.slice(0,6)));<br> }<br> }<br> const map={}; ids.forEach(id=>map[id]=NAME_MEMO.get(id));<br> return map;<br>}<br><br>/* ---------- League (NHL) ---------- */<br>function leagueFactory(){<br> const st={ events:[], selected:null, poll:null, gameRows:[] };<br> const dom={ gridCard:$('nhl-gridCard'), note:$('nhl-note'), grid:$('nhl-grid'), top:$('nhl-top'), back:$('nhl-back'), add:$('nhl-addPick'), live:$('nhl-liveHeader'), teamSide:$('nhl-teamSide'), fscore:$('nhl-fscore'), bonus:$('nhl-bonuses'), clock:$('nhl-clock'), q:$('nhl-q'), state:$('nhl-state'), log:$('nhl-log'), gameLB:$('nhl-gameLB'), userLB:$('nhl-userLB') };<br> const api={ scoreboard:(d)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard?dates=${d.replace(/-/g,'')}`, summary:(id)=>`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${id}` };<br><br> dom.back.addEventListener('click', ()=>{ dom.top.style.display='none'; dom.gridCard.style.display='block'; st.selected=null; });<br> dom.add.addEventListener('click', async ()=>{<br> if(!currentUser){ alert('Sign in first.'); return; }<br> if(!st.selected) return;<br> const kick=new Date(st.selected.start).getTime();<br> if(Date.now()>=kick){ alert('Locked (already started)'); return; }<br> const myList = await picksForUser(currentUser.id);<br> const gid=String(st.selected.id);<br> if(myList.includes(gid)){ alert('Already picked.'); return; }<br> if(myList.length>=MAX_PICKS){ alert(`You already have ${MAX_PICKS} picks in NHL.`); return; }<br> const ok = await setPick(currentUser.id,gid);<br> if(ok){<br> updatePicksLeft();<br> renderWeeklyBoards();<br> renderMyPicks();<br> const tag=$(`picked-${gid}`); if(tag) tag.style.display='inline-flex';<br> const btn=document.querySelector(`.pickBtn[data-gid="${gid}"]`); if(btn) btn.style.display='none';<br> toast('Pick saved ✓');<br> }<br> });<br><br> function renderGrid(){<br> dom.grid.innerHTML='';<br> (st.events||[]).forEach(g=>{<br> const started=Date.now()>=new Date(g.start).getTime();<br> const card=document.createElement('div');<br> card.className='gameCard';<br> const puck=new Date(g.start).toLocaleString([], {weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});<br> card.innerHTML=`<br> <div class="band" style="background:linear-gradient(90deg, ${g.away.color?('#'+g.away.color):'#1a232d'} 0%, ${g.home.color?('#'+g.home.color):'#26313c'} 100%)"></div><br> <div class="gameBody"><br> <div class="teamsRow"><br> <div class="team">${g.away.logo?`<img src="${g.away.logo}" alt="">`:``}<div class="name">${g.away.name}</div><span class="scoreTag" id="NHL-a-${g.id}">0</span></div><br> <div class="small" style="opacity:.8">@</div><br> <div class="team" style="justify-content:flex-end">${g.home.logo?`<img src="${g.home.logo}" alt="">`:``}<div class="name">${g.home.name}</div><span class="scoreTag" id="NHL-h-${g.id}">0</span></div><br> </div><br> <div class="small" style="margin-top:6px;opacity:.9">Score: <span id="NHL-scr-${g.id}">—</span> · <span id="NHL-st-${g.id}">pre</span> · Puck drop: ${puck}</div><br> <div class="lockRow"><br> <span class="pickedTag" style="display:none" id="picked-${g.id}">✓ Picked</span><br> <button class="btn pickBtn" data-gid="${g.id}" ${started?'style="display:none"':''}>Add to my picks</button><br> <button class="btn small viewBtn">Open</button><br> </div><br> ${started?'<div class="small" style="color:#c78;margin-top:6px">Locked (already started)</div>':''}<br> </div>`;<br> card.querySelector('.viewBtn').addEventListener('click',()=>openGame(g));<br> const pickBtn=card.querySelector('.pickBtn');<br> if(pickBtn){<br> pickBtn.addEventListener('click', async ()=>{<br> if(!currentUser){ alert('Sign in first.'); return; }<br> if(Date.now()>=new Date(g.start).getTime()){ alert('Locked (already started)'); return; }<br> const myList = await picksForUser(currentUser.id);<br> const gid=String(g.id);<br> if(myList.includes(gid)){ alert('Already picked.'); return; }<br> if(myList.length>=MAX_PICKS){ alert(`You already have ${MAX_PICKS} picks in NHL.`); return; }<br> const ok = await setPick(currentUser.id,gid);<br> if(ok){<br> updatePicksLeft();<br> renderWeeklyBoards();<br> renderMyPicks();<br> const tag=$(`picked-${g.id}`); if(tag) tag.style.display='inline-flex';<br> pickBtn.style.display='none';<br> toast('Pick saved ✓');<br> }<br> });<br> }<br> dom.grid.appendChild(card);<br> });<br> }<br><br> async function refreshGridScores(){<br> const evs = st.events||[]; if(!evs.length) return;<br> const rows = await pLimitAll(evs, 6, async (g)=>{<br> try{<br> const s=await safeJson(api.summary(g.id));<br> const comp=s?.header?.competitions?.[0]||{};<br> let homeC=null,awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });<br> const sc=parseNHL(s);<br> return { id:g.id, awayPts:sc.awayPts, homePts:sc.homePts, score:sc.total, status:(comp.status?.type?.shortDetail||comp.status?.type?.description||'—') };<br> }catch{ return null; }<br> });<br> const valid=rows.filter(Boolean);<br> for(const r of valid){<br> const scEl=$(`NHL-scr-${r.id}`), stEl=$(`NHL-st-${r.id}`), aEl=$(`NHL-a-${r.id}`), hEl=$(`NHL-h-${r.id}`);<br> if(scEl) scEl.textContent=`${r.awayPts}–${r.homePts}`;<br> if(stEl) stEl.textContent=r.status||'—';<br> if(aEl) aEl.textContent=r.awayPts;<br> if(hEl) hEl.textContent=r.homePts;<br> }<br> st.gameRows = evs.map(g=>{<br> const r = valid.find(x=>x && String(x.id)===String(g.id));<br> if(!r) return null;<br> return { id:g.id, awayName:g.away.name, homeName:g.home.name, awayLogo:g.away.logo, homeLogo:g.home.logo, score:r.score, status:r.status };<br> }).filter(Boolean).sort((a,b)=>b.score-a.score);<br> renderGameLB();<br> renderUserLB();<br> }<br><br> function openGame(g){<br> st.selected=g;<br> $('nhl-top').setAttribute('data-show','true');<br> dom.live.textContent=`${g.away.name} @ ${g.home.name}`;<br> dom.teamSide.innerHTML=<br> `<div class="teamline" style="border-left:6px solid ${g.away.color?('#'+g.away.color):'#2a3643'}"><br> <div style="display:flex;gap:10px;align-items:center">${g.away.logo?`<img src="${g.away.logo}" alt="">`:''}<div style="font-weight:700">${g.away.name}</div></div><br> <div id="NHL-awayScore" style="font-weight:800">—</div><br> </div><br> <div class="teamline" style="border-left:6px solid ${g.home.color?('#'+g.home.color):'#2a3643'}"><br> <div style="display:flex;gap:10px;align-items:center">${g.home.logo?`<img src="${g.home.logo}" alt="">`:''}<div style="font-weight:700">${g.home.name}</div></div><br> <div id="NHL-homeScore" style="font-weight:800">—</div><br> </div>`;<br> dom.gridCard.style.display='none'; dom.top.style.display='block';<br> updateGameOnce(); if(st.poll) clearInterval(st.poll); st.poll=setInterval(updateGameOnce,45000);<br> renderGameLB(); renderUserLB();<br> }<br><br> async function updateGameOnce(){<br> if(!st.selected) return; const id=st.selected.id;<br> try{<br> const s=await safeJson(api.summary(id));<br> const comp=s?.header?.competitions||[];<br> const c0=(comp[0]||{}); const status=c0.status||{};<br> let homeC=null,awayC=null; (c0.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });<br> $('NHL-homeScore').textContent=String(homeC?.score??0);<br> $('NHL-awayScore').textContent=String(awayC?.score??0);<br> dom.clock.textContent=status.displayClock||'—';<br> dom.q.textContent=String(status.period??'—');<br> dom.state.textContent=(status.type?.description||status.type?.shortDetail||'—');<br> const sc=parseNHL(s);<br> dom.fscore.textContent=sc.total.toFixed(2);<br> dom.bonus.textContent=`Bonuses: ${sc.closeBonus?`Close +${sc.closeBonus}`:'—'} · ${sc.otBonus?`OT +${sc.otBonus}`:'—'} · ${sc.soBonus?`SO +${sc.soBonus}`:'—'} (cap ${H.BONUS_CAP})`;<br> const sps=s?.scoringPlays||[];<br> dom.log.innerHTML='';<br> for(const sp of sps.slice(-10).reverse()){<br> const t=(sp.clock?.displayValue||''), q=(sp.period?.number?'P'+sp.period.number:''), d=(sp.text||sp.description||'');<br> const div=document.createElement('div'); div.textContent=`[${q} ${t}] ${d}`; dom.log.appendChild(div);<br> }<br> }catch(e){}<br> }<br><br> async function loadWeek(){<br> dom.note.textContent=`Loading NHL games for ${WEEK.start} → ${WEEK.end} …`;<br> const all=[];<br> for(const d of WEEK.list){<br> const sb=await safeJson(api.scoreboard(d)).catch(()=>null);<br> const evs=sb?.events||[];<br> for(const ev of evs){<br> const c=ev.competitions?.[0]||{};<br> let home=null,away=null; (c.competitors||[]).forEach(x=>{ if(x.homeAway==='home') home=x; if(x.homeAway==='away') away=x; });<br> all.push({<br> id:ev.id,<br> start:ev.date,<br> home:{ name:home?.team?(home.team.shortDisplayName||home.team.displayName):'Home', color:home?.team?.color||null, logo:cdnNHL(home?.team||null) },<br> away:{ name:away?.team?(away.team.shortDisplayName||away.team.displayName):'Away', color:away?.team?.color||null, logo:cdnNHL(away?.team||null) }<br> });<br> }<br> }<br> all.sort((a,b)=>new Date(a.start)-new Date(b.start));<br> st.events=all;<br> dom.note.textContent=`${all.length} games`;<br> renderGrid();<br> if(currentUser){<br> const mine = await picksForUser(currentUser.id);<br> mine.forEach(gid=>{ const tag=$(`picked-${gid}`); if(tag) tag.style.display='inline-flex'; const btn=document.querySelector(`.pickBtn[data-gid="${gid}"]`); if(btn) btn.style.display='none'; });<br> }<br> refreshGridScores();<br> setInterval(refreshGridScores,45000);<br> }<br> return { loadWeek, state:st };<br>}<br>const NHL = leagueFactory();<br><br>/* ---------- Summary/score caching ---------- */<br>async function gameScore(gid){<br> const ck=`score:${gid}`;<br> const c=getCache(ck);<br> if(c!=null) return c;<br> try{<br> const s=await safeJson(`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${gid}`);<br> const parsed = parseNHL(s);<br> const val = parsed.total || 0;<br> const comp = s?.header?.competitions?.[0]||{};<br> const isFinal = (comp.status?.type?.state==='post' || comp.status?.type?.completed===true);<br> const period = Number(comp.status?.period||0);<br> const isLive = !isFinal && period>0;<br> let ttl = 10*60*1000;<br> if(isLive) ttl = 60*1000;<br> if(isFinal) ttl = 6*60*60*1000;<br> setCache(ck, val, ttl);<br> return val;<br> }catch{ return 0; }<br>}<br>async function gameMeta(gid){<br> const ck=`meta:${gid}`;<br> const c=getCache(ck);<br> if(c) return c;<br> const ev=NHL.state.events.find(e=>String(e.id)===String(gid));<br> if(ev){<br> const m={awayName:ev.away.name,homeName:ev.home.name,awayLogo:ev.away.logo,homeLogo:ev.home.logo};<br> setCache(ck,m,24*60*60*1000);<br> return m;<br> }<br> try{<br> const s=await safeJson(`https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/summary?event=${gid}`);<br> const comp=s?.header?.competitions?.[0]||{}; let home=null,away=null; (comp.competitors||[]).forEach(x=>{ if(x.homeAway==='home') home=x; if(x.homeAway==='away') away=x; });<br> const m={ awayName:away?.team?(away.team.shortDisplayName||away.team.displayName):'Away', homeName:home?.team?(home.team.shortDisplayName||home.team.displayName):'Home', awayLogo:cdnNHL(away?.team||null), homeLogo:cdnNHL(home?.team||null) };<br> setCache(ck,m,24*60*60*1000);<br> return m;<br> }catch{ return {awayName:'Away',homeName:'Home',awayLogo:null,homeLogo:null}; }<br>}<br><br>/* ---------- Boards ---------- */<br>const lbWeekBox={ NHL:$('lbNHLWeek') };<br>const lbSeasonBox={ NHL:$('lbNHLSeason') };<br>function ordinal(n){ const s=["th","st","nd","rd"], v=n%100; return n+ (s[(v-20)%10]||s[v]||s[0]); }<br><br>async function renderWeeklyBoards(){<br> const box=lbWeekBox.NHL;<br> if(!box) return;<br> box.innerHTML='<div class="small">Computing…</div>';<br> const rows = await allPicksThisWeek();<br> if(!rows.length){ box.innerHTML='<div class="small">No picks yet.</div>'; return; }<br> const byUser=new Map();<br> for(const r of rows){ const a=byUser.get(r.user_id)||[]; a.push(String(r.game_id)); byUser.set(r.user_id,a); }<br> const ids=[...byUser.keys()];<br> const names=await getDisplayNames(ids);<br> const computed = await pLimitAll(ids, 6, async (uid)=>{<br> const lst = uniqLimit(byUser.get(uid)||[]);<br> const scores = await Promise.all(lst.map(g=>gameScore(g)));<br> const total = scores.reduce((a,b)=>a+(b||0),0);<br> return { uid, name:names[uid]||uid.slice(0,6), total, picks: lst.length };<br> });<br> const out = computed.filter(Boolean).sort((a,b)=>b.total-a.total);<br> box.innerHTML='';<br> out.forEach((r,i)=>{<br> const div=document.createElement('div'); div.className='lbRow';<br> div.innerHTML=`<span class="lbPos">${ordinal(i+1)}</span><div class="lbTeam"><span class="lbName">${r.name}</span> <span class="small" style="margin-left:6px;opacity:.8">(${r.picks}/${MAX_PICKS})</span></div><div class="lbPts">${r.total.toFixed(2)}</div><div class="small">Weekly</div>`;<br> box.appendChild(div);<br> });<br>}<br><br>async function renderSeasonBoards(){<br> const box=lbSeasonBox.NHL; if(!box) return;<br> box.innerHTML='<div class="small">Computing…</div>';<br> const { data, error } = await supa.from('season_points')<br> .select('user_id, points')<br> .eq('league','NHL');<br> if(error){ console.error(error); box.innerHTML='<div class="small">Error.</div>'; return; }<br> if(!data || !data.length){ box.innerHTML='<div class="small">No season data yet.</div>'; return; }<br> const totals={}; data.forEach(r=>{ totals[r.user_id]=(totals[r.user_id]||0)+Number(r.points||0); });<br> const ids=Object.keys(totals);<br> const names=await getDisplayNames(ids);<br> const rows=ids.map(uid=>({uid, name:names[uid]||uid.slice(0,6), total:totals[uid]})).sort((a,b)=>b.total-a.total);<br> box.innerHTML='';<br> rows.forEach((r,i)=>{<br> const div=document.createElement('div'); div.className='lbRow';<br> div.innerHTML=`<span class="lbPos">${ordinal(i+1)}</span><div class="lbTeam"><span class="lbName">${r.name}</span></div><div class="lbPts">${r.total}</div><div class="small">Season</div>`;<br> box.appendChild(div);<br> });<br>}<br><br>/* ---------- Weekly → Season awards (Top10 = 10..1 pts) ---------- */<br>/* Only runs Monday >= 08:00 CT. Idempotent: skips if rows already exist for prev week. */<br>function isAwardWindowNow(){<br> const n=nowCT();<br> const wd=n.getDay(); // Monday = 1<br> const hr=Number(parts(n,{hour:'2-digit',hour12:false}).hour);<br> return wd===1 && hr>=8;<br>}<br>async function maybeAwardSeasonPoints(){<br> if(!isAwardWindowNow()) return;<br> const prevWK = prevWeekKey();<br><br> // if already awarded for prevWK, bail<br> const { data:already, error:chkErr } = await supa<br> .from('season_points')<br> .select('user_id', { count: 'exact' })<br> .eq('league','NHL')<br> .eq('week_key', prevWK)<br> .limit(1);<br> if(chkErr){ console.error(chkErr); return; }<br> if(already && already.length>0) return;<br><br> // compute previous week's standings from picks<br> const rows = await allPicksForWeek(prevWK);<br> if(!rows.length) return;<br><br> const byUser=new Map();<br> for(const r of rows){ const a=byUser.get(r.user_id)||[]; a.push(String(r.game_id)); byUser.set(r.user_id,a); }<br> const ids=[...byUser.keys()];<br> const computed = await pLimitAll(ids, 6, async (uid)=>{<br> const lst = uniqLimit(byUser.get(uid)||[]);<br> const scores = await Promise.all(lst.map(g=>gameScore(g)));<br> const total = scores.reduce((a,b)=>a+(b||0),0);<br> return { uid, total };<br> });<br> const ranked = computed.filter(Boolean).sort((a,b)=>b.total-a.total);<br> const PTS=[10,9,8,7,6,5,4,3,2,1];<br> const awards = ranked.slice(0,10).map((r,i)=>({<br> user_id: r.uid,<br> league: 'NHL',<br> week_key: prevWK,<br> points: PTS[i]<br> }));<br><br> if(awards.length){<br> const { error:insErr } = await supa<br> .from('season_points')<br> .upsert(awards, { onConflict: 'user_id,league,week_key' });<br> if(insErr){ console.error(insErr); }<br> }<br>}<br><br>/* ---------- My Picks ---------- */<br>const RENDER_TICKETS = new Map();<br>function nextTicket(key){ const n=(RENDER_TICKETS.get(key)||0)+1; RENDER_TICKETS.set(key,n); return n; }<br>function isCurrent(key,t){ return RENDER_TICKETS.get(key)===t; }<br>let LAST_ALL_IDS_JSON = '';<br>function gameRowHTML(meta,score){<br> return `<div class="lbTeam">${meta.awayLogo?`<img src="${meta.awayLogo}" alt="">`:''}<span class="lbName" style="max-width:280px">${meta.awayName} @ ${meta.homeName}</span>${meta.homeLogo?`<img src="${meta.homeLogo}" alt="" style="margin-left:6px">`:''}</div><div class="lbPts">${score.toFixed(2)}</div><div class="small">Game</div>`;<br>}<br>async function renderPickList(containerId, gidList){<br> const el=$(containerId);<br> const myTicket = nextTicket(containerId);<br> const clean=uniqLimit(gidList||[]);<br> el.innerHTML='';<br> if(clean.length===0){<br> if(isCurrent(containerId,myTicket)) el.innerHTML='<div class="small">No picks yet.</div>';<br> return 0;<br> }<br> const results = await pLimitAll(clean, 6, async (gid)=>{<br> const [meta,score]=await Promise.all([gameMeta(gid), gameScore(gid)]);<br> return {meta,score:score||0};<br> });<br> if(!isCurrent(containerId,myTicket)) return 0;<br> let total=0; const rows=[];<br> for(const r of results){ total+=r.score; rows.push(`<div class="lbRow">${gameRowHTML(r.meta,r.score)}</div>`); }<br> el.innerHTML=rows.join('');<br> return total;<br>}<br>async function renderMyPicks(){<br> if(!currentUser){ $('myNHL').innerHTML='<div class="small">Sign in to see your picks.</div>'; $('allPicks').innerHTML='<div class="small">Sign in to see everyone.</div>'; return; }<br> const myList = await picksForUser(currentUser.id);<br> const tot = await renderPickList('myNHL', myList);<br> $('myNHLTotal').textContent = tot.toFixed(2);<br> const box=$('allPicks');<br> const rows = await allPicksThisWeek();<br> const byUser=new Map(); rows.forEach(r=>{ const a=byUser.get(r.user_id)||[]; a.push(String(r.game_id)); byUser.set(r.user_id,a); });<br> const ids=[...byUser.keys()];<br> if(!ids.length){ box.innerHTML='<div class="small">No picks yet.</div>'; return; }<br> const idsJson = JSON.stringify(ids.slice().sort());<br> if(idsJson !== LAST_ALL_IDS_JSON){<br> LAST_ALL_IDS_JSON = idsJson;<br> const names=await getDisplayNames(ids);<br> const frags=[]; ids.forEach(uid=>{<br> frags.push(`<div class="panel" style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${names[uid]||uid.slice(0,6)}</strong><span class="small" id="sum-${uid}">NHL —</span></div><div class="sep"></div><div id="p-${uid}-nhl"></div></div>`);<br> });<br> box.innerHTML=frags.join('');<br> }<br> await pLimitAll(ids, 6, async (uid)=>{<br> const t = await renderPickList(`p-${uid}-nhl`, uniqLimit(byUser.get(uid)||[]));<br> const sumEl = $(`sum-${uid}`); if(sumEl) sumEl.textContent = `NHL ${t.toFixed(2)}`;<br> });<br>}<br><br>/* ---------- Picks-left badge ---------- */<br>async function updatePicksLeft(){<br> if(!currentUser){ $('picksLeft').textContent='Sign in to play'; return; }<br> const n=(await picksForUser(currentUser.id)).length;<br> $('picksLeft').textContent=`NHL ${Math.max(MAX_PICKS-n,0)} left`;<br>}<br><br>/* ---------- Tabs ---------- */<br>const tabs={ nhl:{tab:$('tab-nhl'),sec:$('sec-nhl')}, mine:{tab:$('tab-mine'),sec:$('sec-mine')}, lb:{tab:$('tab-lb'),sec:$('sec-lb')}, rules:{tab:$('tab-rules'),sec:$('sec-rules')} };<br>Object.keys(tabs).forEach(k=>tabs[k].tab.addEventListener('click',()=>{ Object.keys(tabs).forEach(x=>{ tabs[x].tab.setAttribute('aria-selected', x===k?'true':'false'); tabs[x].sec.classList.toggle('active', x===k); }); if(k==='mine') renderMyPicks(); if(k==='lb'){ renderWeeklyBoards(); renderSeasonBoards(); }}));<br><br>/* ---------- Boot ---------- */<br>(async ()=>{<br> const { data:{ session:ses } } = await supa.auth.getSession();<br> session=ses; currentUser = session?.user || null;<br> function showAuthUI(){<br> if(currentUser){<br> $('loginForm').style.display='none';<br> $('userBox').style.display='flex';<br> $('whoami').textContent = currentUser.email || '(no email)';<br> }else{<br> $('loginForm').style.display='flex';<br> $('userBox').style.display='none';<br> }<br> }<br> showAuthUI();<br> if(currentUser){ await loadOrCreatePlayer(); }<br> const league = NHL; await league.loadWeek();<br> await updatePicksLeft();<br> await renderWeeklyBoards();<br><br> /* >>> award Top10 season points for PREVIOUS week (Mon ≥ 08:00 CT) <<< */<br> await maybeAwardSeasonPoints();<br><br> await renderSeasonBoards();<br> await renderMyPicks();<br> supa.auth.onAuthStateChange(async (_event, sess)=>{<br> session=sess; currentUser=session?.user||null; showAuthUI();<br> if(currentUser){ await loadOrCreatePlayer(); }<br> await updatePicksLeft();<br> await renderMyPicks();<br> await renderWeeklyBoards();<br> if(currentUser && NHL?.state?.events){<br> const mine = await picksForUser(currentUser.id);<br> mine.forEach(gid=>{ const tag=$(`picked-${gid}`); if(tag) tag.style.display='inline-flex'; const btn=document.querySelector(`.pickBtn[data-gid="${gid}"]`); if(btn) btn.style.display='none'; });<br> }<br> });<br> setInterval(renderWeeklyBoards, 60000);<br>})();<br></script><br></body><br></html></div>


