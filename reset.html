<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reset Password · QuickPucks</title>
<style>
  body{font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b0d10;color:#e8eef4}
  .wrap{max-width:460px;margin:56px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;margin-top:8px}
  input{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:#e8eef4;padding:10px;font-size:16px}
  button{background:#14202b;border:1px solid #243241;color:#e8eef4;padding:10px 14px;border-radius:10px;cursor:pointer}
  .msg{margin-top:10px;font-size:13px;color:#9bb3c9;white-space:pre-wrap}
  .err{color:#ff9595}
  .ok{color:#9fe3a8}
  .muted{opacity:.9}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Password reset</h1>
    <div class="card">
      <div id="status" class="msg muted">Loading…</div>
      <div class="row">
        <input id="newpass" type="password" placeholder="New password (min 6)" autocomplete="new-password" />
        <button id="setpass" type="button">Update</button>
      </div>
      <div id="msg" class="msg"></div>
    </div>
    <div class="msg muted" style="margin-top:12px">
      Tip: open this page from the email link (don’t copy/paste). The link carries a one-time token.
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  (function(){
    const SUPA_URL  = "https://acmqdokxwnkkjmfgfyhh.supabase.co";
    const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w";

    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');
    const msgEl = $('msg');
    const btn = $('setpass');
    const input = $('newpass');

    function showStatus(t, cls){ statusEl.textContent=t; statusEl.className = "msg " + (cls||""); }
    function showMsg(t, cls){ msgEl.textContent=t; msgEl.className = "msg " + (cls||""); }

    function urlQuery(name){
      return new URLSearchParams(location.search).get(name);
    }
    function urlHash(name){
      const h = new URLSearchParams(location.hash.replace(/^#/,''));
      return h.get(name);
    }

    function assertSupabase(){
      if(!window.supabase){
        showStatus("Failed to load Supabase SDK. Check network/adblock.", "err");
        throw new Error("supabase sdk missing");
      }
    }

    let supa;
    async function init(){
      try{
        assertSupabase();
        supa = window.supabase.createClient(SUPA_URL, SUPA_ANON, {
          auth: { persistSession: true, detectSessionInUrl: true, flowType: 'pkce' }
        });
      }catch(e){
        showMsg(String(e.message||e), "err");
        return;
      }

      // Try to establish a session from the URL
      try{
        let established = false;

        // 1) PKCE links: ?code=...
        const code = urlQuery('code');
        if(code){
          const { error } = await supa.auth.exchangeCodeForSession(code);
          if(!error){ established = true; }
        }

        // 2) Legacy hash links: #access_token=&refresh_token=
        if(!established){
          const at = urlHash('access_token');
          const rt = urlHash('refresh_token');
          if(at && rt){
            const { error } = await supa.auth.setSession({ access_token: at, refresh_token: rt });
            if(!error){ established = true; }
          }
        }

        // 3) Already have one?
        if(!established){
          const { data } = await supa.auth.getSession();
          established = !!data?.session;
        }

        if(established){
          showStatus("Ready. Enter your new password and press Update.", "ok");
        }else{
          showStatus("This page is missing the auth token from your email link.", "err");
          showMsg("Open the password reset link directly from your email, or click “Forgot?” again on the site to get a fresh link.", "err");
        }
      }catch(e){
        showStatus("Error while reading auth token.", "err");
        showMsg(String(e.message||e), "err");
      }
    }

    btn.addEventListener('click', async ()=>{
      try{
        if(!supa){ showMsg("Supabase not initialized.", "err"); return; }
        const p = (input.value||"").trim();
        if(p.length < 6){ showMsg("Password must be at least 6 characters.", "err"); return; }
        btn.disabled = true;
        showMsg("Updating…");
        const { error } = await supa.auth.updateUser({ password: p });
        if(error){ showMsg(error.message, "err"); btn.disabled=false; return; }
        showMsg("Password updated. You can close this tab and log in.", "ok");
      }catch(e){
        showMsg(String(e.message||e), "err");
        btn.disabled = false;
      }
    });

    // Boot
    init();
  })();
  </script>
</body>
</html>
