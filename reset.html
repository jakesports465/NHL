<script>
  const SUPA_URL  = "https://acmqdokxwnkkjmfgfyhh.supabase.co";
  const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjbXFkb2t4d25ra2ptZmdmeWhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDY4MDAsImV4cCI6MjA3Mzg4MjgwMH0.cHgUbNwXQvWZJnQNetxO5kr0kVPIR2XO9vVkIJZj_-w";

  const supabase = window.supabase.createClient(SUPA_URL, SUPA_ANON, {
    auth: { persistSession: true, detectSessionInUrl: true, flowType: 'pkce' }
  });

  const $ = (id) => document.getElementById(id);
  const msg = $('msg');

  async function ensureSessionFromUrl() {
    // 1) PKCE-style links -> ?code=...
    const code = new URLSearchParams(location.search).get('code');
    if (code) {
      const { error } = await supabase.auth.exchangeCodeForSession(code);
      if (!error) return true;
    }

    // 2) Legacy hash links -> #access_token=...&refresh_token=...
    const hash = new URLSearchParams(location.hash.replace(/^#/, ''));
    const access_token = hash.get('access_token');
    const refresh_token = hash.get('refresh_token');
    if (access_token && refresh_token) {
      const { error } = await supabase.auth.setSession({ access_token, refresh_token });
      if (!error) return true;
    }

    // 3) Maybe we already have it
    const { data: s } = await supabase.auth.getSession();
    return !!s?.session;
  }

  (async () => {
    const ok = await ensureSessionFromUrl();
    if (!ok) {
      msg.textContent = "Reset link is missing auth context. Open the link directly from your email (don’t copy/paste). If it still fails, click “Forgot?” again to get a fresh link.";
      return;
    }
    msg.textContent = "Ready. Enter a new password and press Update.";
  })();

  $('setpass').onclick = async () => {
    const p = $('newpass').value;
    if (!p || p.length < 6) {
      msg.textContent = "Password must be at least 6 characters.";
      return;
    }
    const { error } = await supabase.auth.updateUser({ password: p });
    msg.textContent = error ? error.message : "Password updated. You can close this tab and log in.";
  };
</script>
